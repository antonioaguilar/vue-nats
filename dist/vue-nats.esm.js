var commonjsGlobal="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function createCommonjsModule(e,t){return e(t={exports:{}},t.exports),t.exports}function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}!function(e,t){if(!e.setImmediate){var n,r,i,s,o,a=1,u={},c=!1,l=e.document,h=Object.getPrototypeOf&&Object.getPrototypeOf(e);h=h&&h.setTimeout?h:e,"[object process]"==={}.toString.call(e.process)?n=function(e){process.nextTick(function(){f(e)})}:!function(){if(e.postMessage&&!e.importScripts){var t=!0,n=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=n,t}}()?e.MessageChannel?((i=new MessageChannel).port1.onmessage=function(e){f(e.data)},n=function(e){i.port2.postMessage(e)}):l&&"onreadystatechange"in l.createElement("script")?(r=l.documentElement,n=function(e){var t=l.createElement("script");t.onreadystatechange=function(){f(e),t.onreadystatechange=null,r.removeChild(t),t=null},r.appendChild(t)}):n=function(e){setTimeout(f,0,e)}:(s="setImmediate$"+Math.random()+"$",o=function(t){t.source===e&&"string"==typeof t.data&&0===t.data.indexOf(s)&&f(+t.data.slice(s.length))},e.addEventListener?e.addEventListener("message",o,!1):e.attachEvent("onmessage",o),n=function(t){e.postMessage(s+t,"*")}),h.setImmediate=function(e){"function"!=typeof e&&(e=new Function(""+e));for(var t=new Array(arguments.length-1),r=0;r<t.length;r++)t[r]=arguments[r+1];var i={callback:e,args:t};return u[a]=i,n(a),a++},h.clearImmediate=p}function p(e){delete u[e]}function f(e){if(c)setTimeout(f,0,e);else{var n=u[e];if(n){c=!0;try{!function(e){var n=e.callback,r=e.args;switch(r.length){case 0:n();break;case 1:n(r[0]);break;case 2:n(r[0],r[1]);break;case 3:n(r[0],r[1],r[2]);break;default:n.apply(t,r)}}(n)}finally{p(e),c=!1}}}}}("undefined"==typeof self?commonjsGlobal:self);var cachedSetTimeout=defaultSetTimout,cachedClearTimeout=defaultClearTimeout;function runTimeout(e){if(cachedSetTimeout===setTimeout)return setTimeout(e,0);if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout)return cachedSetTimeout=setTimeout,setTimeout(e,0);try{return cachedSetTimeout(e,0)}catch(t){try{return cachedSetTimeout.call(null,e,0)}catch(t){return cachedSetTimeout.call(this,e,0)}}}function runClearTimeout(e){if(cachedClearTimeout===clearTimeout)return clearTimeout(e);if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout)return cachedClearTimeout=clearTimeout,clearTimeout(e);try{return cachedClearTimeout(e)}catch(t){try{return cachedClearTimeout.call(null,e)}catch(t){return cachedClearTimeout.call(this,e)}}}"function"==typeof global.setTimeout&&(cachedSetTimeout=setTimeout),"function"==typeof global.clearTimeout&&(cachedClearTimeout=clearTimeout);var currentQueue,queue=[],draining=!1,queueIndex=-1;function cleanUpNextTick(){draining&&currentQueue&&(draining=!1,currentQueue.length?queue=currentQueue.concat(queue):queueIndex=-1,queue.length&&drainQueue())}function drainQueue(){if(!draining){var e=runTimeout(cleanUpNextTick);draining=!0;for(var t=queue.length;t;){for(currentQueue=queue,queue=[];++queueIndex<t;)currentQueue&&currentQueue[queueIndex].run();queueIndex=-1,t=queue.length}currentQueue=null,draining=!1,runClearTimeout(e)}}function nextTick(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];queue.push(new Item(e,t)),1!==queue.length||draining||runTimeout(drainQueue)}function Item(e,t){this.fun=e,this.array=t}Item.prototype.run=function(){this.fun.apply(null,this.array)};var title="browser",platform="browser",browser=!0,env={},argv=[],version="",versions={},release={},config={};function noop(){}var on=noop,addListener=noop,once=noop,off=noop,removeListener=noop,removeAllListeners=noop,emit=noop;function binding(e){throw new Error("process.binding is not supported")}function cwd(){return"/"}function chdir(e){throw new Error("process.chdir is not supported")}function umask(){return 0}var performance=global.performance||{},performanceNow=performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow||function(){return(new Date).getTime()};function hrtime(e){var t=.001*performanceNow.call(performance),n=Math.floor(t),r=Math.floor(t%1*1e9);return e&&(n-=e[0],(r-=e[1])<0&&(n--,r+=1e9)),[n,r]}var startTime=new Date;function uptime(){return(new Date-startTime)/1e3}var inherits,process$1={nextTick:nextTick,title:title,browser:browser,env:env,argv:argv,version:version,versions:versions,on:on,addListener:addListener,once:once,off:off,removeListener:removeListener,removeAllListeners:removeAllListeners,emit:emit,binding:binding,cwd:cwd,chdir:chdir,umask:umask,hrtime:hrtime,platform:platform,release:release,config:config,uptime:uptime},inherits$1=inherits="function"==typeof Object.create?function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}:function(e,t){e.super_=t;var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e},formatRegExp=/%[sdj%]/g;function format(e){if(!isString(e)){for(var t=[],n=0;n<arguments.length;n++)t.push(inspect(arguments[n]));return t.join(" ")}n=1;for(var r=arguments,i=r.length,s=String(e).replace(formatRegExp,function(e){if("%%"===e)return"%";if(n>=i)return e;switch(e){case"%s":return String(r[n++]);case"%d":return Number(r[n++]);case"%j":try{return JSON.stringify(r[n++])}catch(e){return"[Circular]"}default:return e}}),o=r[n];n<i;o=r[++n])isNull(o)||!isObject(o)?s+=" "+o:s+=" "+inspect(o);return s}function deprecate(e,t){if(isUndefined(global.process))return function(){return deprecate(e,t).apply(this,arguments)};var n=!1;return function(){return n||(console.error(t),n=!0),e.apply(this,arguments)}}var debugEnviron,debugs={};function debuglog(e){if(isUndefined(debugEnviron)&&(debugEnviron=process$1.env.NODE_DEBUG||""),e=e.toUpperCase(),!debugs[e])if(new RegExp("\\b"+e+"\\b","i").test(debugEnviron)){debugs[e]=function(){var t=format.apply(null,arguments);console.error("%s %d: %s",e,0,t)}}else debugs[e]=function(){};return debugs[e]}function inspect(e,t){var n={seen:[],stylize:stylizeNoColor};return arguments.length>=3&&(n.depth=arguments[2]),arguments.length>=4&&(n.colors=arguments[3]),isBoolean(t)?n.showHidden=t:t&&_extend(n,t),isUndefined(n.showHidden)&&(n.showHidden=!1),isUndefined(n.depth)&&(n.depth=2),isUndefined(n.colors)&&(n.colors=!1),isUndefined(n.customInspect)&&(n.customInspect=!0),n.colors&&(n.stylize=stylizeWithColor),formatValue(n,e,n.depth)}function stylizeWithColor(e,t){var n=inspect.styles[t];return n?"["+inspect.colors[n][0]+"m"+e+"["+inspect.colors[n][1]+"m":e}function stylizeNoColor(e,t){return e}function arrayToHash(e){var t={};return e.forEach(function(e,n){t[e]=!0}),t}function formatValue(e,t,n){if(e.customInspect&&t&&isFunction(t.inspect)&&t.inspect!==inspect&&(!t.constructor||t.constructor.prototype!==t)){var r=t.inspect(n,e);return isString(r)||(r=formatValue(e,r,n)),r}var i=formatPrimitive(e,t);if(i)return i;var s=Object.keys(t),o=arrayToHash(s);if(e.showHidden&&(s=Object.getOwnPropertyNames(t)),isError(t)&&(s.indexOf("message")>=0||s.indexOf("description")>=0))return formatError(t);if(0===s.length){if(isFunction(t)){var a=t.name?": "+t.name:"";return e.stylize("[Function"+a+"]","special")}if(isRegExp(t))return e.stylize(RegExp.prototype.toString.call(t),"regexp");if(isDate(t))return e.stylize(Date.prototype.toString.call(t),"date");if(isError(t))return formatError(t)}var u,c="",l=!1,h=["{","}"];(isArray(t)&&(l=!0,h=["[","]"]),isFunction(t))&&(c=" [Function"+(t.name?": "+t.name:"")+"]");return isRegExp(t)&&(c=" "+RegExp.prototype.toString.call(t)),isDate(t)&&(c=" "+Date.prototype.toUTCString.call(t)),isError(t)&&(c=" "+formatError(t)),0!==s.length||l&&0!=t.length?n<0?isRegExp(t)?e.stylize(RegExp.prototype.toString.call(t),"regexp"):e.stylize("[Object]","special"):(e.seen.push(t),u=l?formatArray(e,t,n,o,s):s.map(function(r){return formatProperty(e,t,n,o,r,l)}),e.seen.pop(),reduceToSingleString(u,c,h)):h[0]+c+h[1]}function formatPrimitive(e,t){if(isUndefined(t))return e.stylize("undefined","undefined");if(isString(t)){var n="'"+JSON.stringify(t).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(n,"string")}return isNumber(t)?e.stylize(""+t,"number"):isBoolean(t)?e.stylize(""+t,"boolean"):isNull(t)?e.stylize("null","null"):void 0}function formatError(e){return"["+Error.prototype.toString.call(e)+"]"}function formatArray(e,t,n,r,i){for(var s=[],o=0,a=t.length;o<a;++o)hasOwnProperty(t,String(o))?s.push(formatProperty(e,t,n,r,String(o),!0)):s.push("");return i.forEach(function(i){i.match(/^\d+$/)||s.push(formatProperty(e,t,n,r,i,!0))}),s}function formatProperty(e,t,n,r,i,s){var o,a,u;if((u=Object.getOwnPropertyDescriptor(t,i)||{value:t[i]}).get?a=u.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):u.set&&(a=e.stylize("[Setter]","special")),hasOwnProperty(r,i)||(o="["+i+"]"),a||(e.seen.indexOf(u.value)<0?(a=isNull(n)?formatValue(e,u.value,null):formatValue(e,u.value,n-1)).indexOf("\n")>-1&&(a=s?a.split("\n").map(function(e){return"  "+e}).join("\n").substr(2):"\n"+a.split("\n").map(function(e){return"   "+e}).join("\n")):a=e.stylize("[Circular]","special")),isUndefined(o)){if(s&&i.match(/^\d+$/))return a;(o=JSON.stringify(""+i)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(o=o.substr(1,o.length-2),o=e.stylize(o,"name")):(o=o.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),o=e.stylize(o,"string"))}return o+": "+a}function reduceToSingleString(e,t,n){return e.reduce(function(e,t){return t.indexOf("\n"),e+t.replace(/\u001b\[\d\d?m/g,"").length+1},0)>60?n[0]+(""===t?"":t+"\n ")+" "+e.join(",\n  ")+" "+n[1]:n[0]+t+" "+e.join(", ")+" "+n[1]}function isArray(e){return Array.isArray(e)}function isBoolean(e){return"boolean"==typeof e}function isNull(e){return null===e}function isNullOrUndefined(e){return null==e}function isNumber(e){return"number"==typeof e}function isString(e){return"string"==typeof e}function isSymbol(e){return"symbol"==typeof e}function isUndefined(e){return void 0===e}function isRegExp(e){return isObject(e)&&"[object RegExp]"===objectToString(e)}function isObject(e){return"object"==typeof e&&null!==e}function isDate(e){return isObject(e)&&"[object Date]"===objectToString(e)}function isError(e){return isObject(e)&&("[object Error]"===objectToString(e)||e instanceof Error)}function isFunction(e){return"function"==typeof e}function isPrimitive(e){return null===e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"symbol"==typeof e||void 0===e}function isBuffer(e){return Buffer.isBuffer(e)}function objectToString(e){return Object.prototype.toString.call(e)}function pad(e){return e<10?"0"+e.toString(10):e.toString(10)}inspect.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},inspect.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"};var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function timestamp(){var e=new Date,t=[pad(e.getHours()),pad(e.getMinutes()),pad(e.getSeconds())].join(":");return[e.getDate(),months[e.getMonth()],t].join(" ")}function log(){console.log("%s - %s",timestamp(),format.apply(null,arguments))}function _extend(e,t){if(!t||!isObject(t))return e;for(var n=Object.keys(t),r=n.length;r--;)e[n[r]]=t[n[r]];return e}function hasOwnProperty(e,t){return Object.prototype.hasOwnProperty.call(e,t)}var domain,util={inherits:inherits$1,_extend:_extend,log:log,isBuffer:isBuffer,isPrimitive:isPrimitive,isFunction:isFunction,isError:isError,isDate:isDate,isObject:isObject,isRegExp:isRegExp,isUndefined:isUndefined,isSymbol:isSymbol,isString:isString,isNumber:isNumber,isNullOrUndefined:isNullOrUndefined,isNull:isNull,isBoolean:isBoolean,isArray:isArray,inspect:inspect,deprecate:deprecate,format:format,debuglog:debuglog},util$1=Object.freeze({format:format,deprecate:deprecate,debuglog:debuglog,inspect:inspect,isArray:isArray,isBoolean:isBoolean,isNull:isNull,isNullOrUndefined:isNullOrUndefined,isNumber:isNumber,isString:isString,isSymbol:isSymbol,isUndefined:isUndefined,isRegExp:isRegExp,isObject:isObject,isDate:isDate,isError:isError,isFunction:isFunction,isPrimitive:isPrimitive,isBuffer:isBuffer,log:log,inherits:inherits$1,_extend:_extend,default:util});function EventHandlers(){}function EventEmitter(){EventEmitter.init.call(this)}function $getMaxListeners(e){return void 0===e._maxListeners?EventEmitter.defaultMaxListeners:e._maxListeners}function emitNone(e,t,n){if(t)e.call(n);else for(var r=e.length,i=arrayClone(e,r),s=0;s<r;++s)i[s].call(n)}function emitOne(e,t,n,r){if(t)e.call(n,r);else for(var i=e.length,s=arrayClone(e,i),o=0;o<i;++o)s[o].call(n,r)}function emitTwo(e,t,n,r,i){if(t)e.call(n,r,i);else for(var s=e.length,o=arrayClone(e,s),a=0;a<s;++a)o[a].call(n,r,i)}function emitThree(e,t,n,r,i,s){if(t)e.call(n,r,i,s);else for(var o=e.length,a=arrayClone(e,o),u=0;u<o;++u)a[u].call(n,r,i,s)}function emitMany(e,t,n,r){if(t)e.apply(n,r);else for(var i=e.length,s=arrayClone(e,i),o=0;o<i;++o)s[o].apply(n,r)}function _addListener(e,t,n,r){var i,s,o;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');if((s=e._events)?(s.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),s=e._events),o=s[t]):(s=e._events=new EventHandlers,e._eventsCount=0),o){if("function"==typeof o?o=s[t]=r?[n,o]:[o,n]:r?o.unshift(n):o.push(n),!o.warned&&(i=$getMaxListeners(e))&&i>0&&o.length>i){o.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=e,a.type=t,a.count=o.length,emitWarning(a)}}else o=s[t]=n,++e._eventsCount;return e}function emitWarning(e){"function"==typeof console.warn?console.warn(e):console.log(e)}function _onceWrap(e,t,n){var r=!1;function i(){e.removeListener(t,i),r||(r=!0,n.apply(e,arguments))}return i.listener=n,i}function listenerCount(e){var t=this._events;if(t){var n=t[e];if("function"==typeof n)return 1;if(n)return n.length}return 0}function spliceOne(e,t){for(var n=t,r=n+1,i=e.length;r<i;n+=1,r+=1)e[n]=e[r];e.pop()}function arrayClone(e,t){for(var n=new Array(t);t--;)n[t]=e[t];return n}function unwrapListeners(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}EventHandlers.prototype=Object.create(null),EventEmitter.EventEmitter=EventEmitter,EventEmitter.usingDomains=!1,EventEmitter.prototype.domain=void 0,EventEmitter.prototype._events=void 0,EventEmitter.prototype._maxListeners=void 0,EventEmitter.defaultMaxListeners=10,EventEmitter.init=function(){this.domain=null,EventEmitter.usingDomains&&domain.active&&domain.Domain,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new EventHandlers,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},EventEmitter.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},EventEmitter.prototype.getMaxListeners=function(){return $getMaxListeners(this)},EventEmitter.prototype.emit=function(e){var t,n,r,i,s,o,a,u="error"===e;if(o=this._events)u=u&&null==o.error;else if(!u)return!1;if(a=this.domain,u){if(t=arguments[1],!a){if(t instanceof Error)throw t;var c=new Error('Uncaught, unspecified "error" event. ('+t+")");throw c.context=t,c}return t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=a,t.domainThrown=!1,a.emit("error",t),!1}if(!(n=o[e]))return!1;var l="function"==typeof n;switch(r=arguments.length){case 1:emitNone(n,l,this);break;case 2:emitOne(n,l,this,arguments[1]);break;case 3:emitTwo(n,l,this,arguments[1],arguments[2]);break;case 4:emitThree(n,l,this,arguments[1],arguments[2],arguments[3]);break;default:for(i=new Array(r-1),s=1;s<r;s++)i[s-1]=arguments[s];emitMany(n,l,this,i)}return!0},EventEmitter.prototype.addListener=function(e,t){return _addListener(this,e,t,!1)},EventEmitter.prototype.on=EventEmitter.prototype.addListener,EventEmitter.prototype.prependListener=function(e,t){return _addListener(this,e,t,!0)},EventEmitter.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,_onceWrap(this,e,t)),this},EventEmitter.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,_onceWrap(this,e,t)),this},EventEmitter.prototype.removeListener=function(e,t){var n,r,i,s,o;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(r=this._events))return this;if(!(n=r[e]))return this;if(n===t||n.listener&&n.listener===t)0==--this._eventsCount?this._events=new EventHandlers:(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,s=n.length;s-- >0;)if(n[s]===t||n[s].listener&&n[s].listener===t){o=n[s].listener,i=s;break}if(i<0)return this;if(1===n.length){if(n[0]=void 0,0==--this._eventsCount)return this._events=new EventHandlers,this;delete r[e]}else spliceOne(n,i);r.removeListener&&this.emit("removeListener",e,o||t)}return this},EventEmitter.prototype.removeAllListeners=function(e){var t,n;if(!(n=this._events))return this;if(!n.removeListener)return 0===arguments.length?(this._events=new EventHandlers,this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=new EventHandlers:delete n[e]),this;if(0===arguments.length){for(var r,i=Object.keys(n),s=0;s<i.length;++s)"removeListener"!==(r=i[s])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=new EventHandlers,this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)do{this.removeListener(e,t[t.length-1])}while(t[0]);return this},EventEmitter.prototype.listeners=function(e){var t,n=this._events;return n&&(t=n[e])?"function"==typeof t?[t.listener||t]:unwrapListeners(t):[]},EventEmitter.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):listenerCount.call(e,t)},EventEmitter.prototype.listenerCount=listenerCount,EventEmitter.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var events=Object.freeze({default:EventEmitter,EventEmitter:EventEmitter}),util$2=util$1&&util||util$1,require$$0=events&&EventEmitter||events;let EventEmitter$1=require$$0.EventEmitter;function WebSocketProxy(e){let t=this;EventEmitter$1.call(this),this.sock=new WebSocket(e),this.sock.addEventListener("open",function(){t.emit("connect")}),this.sock.addEventListener("message",function(e){t.emit("data",new Buffer(e.data))}),this.sock.addEventListener("error",function(e){t.emit("error",e)}),this.sock.addEventListener("close",function(){t.emit("close")})}util$2.inherits(WebSocketProxy,EventEmitter$1),WebSocketProxy.prototype.end=function(){this.destroy()},WebSocketProxy.prototype.destroy=function(){this.sock.readyState!==WebSocket.CONNECTING&&this.sock.readyState!==WebSocket.OPEN||this.sock.close()},WebSocketProxy.prototype.write=function(e){this.sock.readyState===WebSocket.OPEN&&this.sock.send(e)},WebSocketProxy.prototype.pause=function(){console.warn("WebSocketProxy stream pause/resume is not supported yet.")},WebSocketProxy.prototype.resume=function(){};var createConnection=function(e){return new WebSocketProxy(e.format({protocol:e.protocol,slashes:e.slashes,host:e.host,hostname:e.hostname,port:e.port,pathname:e.pathname,search:e.search,path:e.path,query:e.query,hash:e.hash}))},net={createConnection:createConnection},connect=function(e,t){throw"TLS is not supported in the browser. Use WSS instead."},tls={connect:connect},maxInt=2147483647,base=36,tMin=1,tMax=26,skew=38,damp=700,initialBias=72,initialN=128,delimiter="-",regexNonASCII=/[^\x20-\x7E]/,regexSeparators=/[\x2E\u3002\uFF0E\uFF61]/g,errors={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},baseMinusTMin=base-tMin,floor=Math.floor,stringFromCharCode=String.fromCharCode;function error(e){throw new RangeError(errors[e])}function map(e,t){for(var n=e.length,r=[];n--;)r[n]=t(e[n]);return r}function mapDomain(e,t){var n=e.split("@"),r="";return n.length>1&&(r=n[0]+"@",e=n[1]),r+map((e=e.replace(regexSeparators,".")).split("."),t).join(".")}function ucs2decode(e){for(var t,n,r=[],i=0,s=e.length;i<s;)(t=e.charCodeAt(i++))>=55296&&t<=56319&&i<s?56320==(64512&(n=e.charCodeAt(i++)))?r.push(((1023&t)<<10)+(1023&n)+65536):(r.push(t),i--):r.push(t);return r}function digitToBasic(e,t){return e+22+75*(e<26)-((0!=t)<<5)}function adapt(e,t,n){var r=0;for(e=n?floor(e/damp):e>>1,e+=floor(e/t);e>baseMinusTMin*tMax>>1;r+=base)e=floor(e/baseMinusTMin);return floor(r+(baseMinusTMin+1)*e/(e+skew))}function encode(e){var t,n,r,i,s,o,a,u,c,l,h,p,f,d,m,v=[];for(p=(e=ucs2decode(e)).length,t=initialN,n=0,s=initialBias,o=0;o<p;++o)(h=e[o])<128&&v.push(stringFromCharCode(h));for(r=i=v.length,i&&v.push(delimiter);r<p;){for(a=maxInt,o=0;o<p;++o)(h=e[o])>=t&&h<a&&(a=h);for(a-t>floor((maxInt-n)/(f=r+1))&&error("overflow"),n+=(a-t)*f,t=a,o=0;o<p;++o)if((h=e[o])<t&&++n>maxInt&&error("overflow"),h==t){for(u=n,c=base;!(u<(l=c<=s?tMin:c>=s+tMax?tMax:c-s));c+=base)m=u-l,d=base-l,v.push(stringFromCharCode(digitToBasic(l+m%d,0))),u=floor(m/d);v.push(stringFromCharCode(digitToBasic(u,0))),s=adapt(n,f,r==i),n=0,++r}++n,++t}return v.join("")}function toASCII(e){return mapDomain(e,function(e){return regexNonASCII.test(e)?"xn--"+encode(e):e})}function hasOwnProperty$1(e,t){return Object.prototype.hasOwnProperty.call(e,t)}var isArray$1=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)};function stringifyPrimitive(e){switch(typeof e){case"string":return e;case"boolean":return e?"true":"false";case"number":return isFinite(e)?e:"";default:return""}}function stringify(e,t,n,r){return t=t||"&",n=n||"=",null===e&&(e=void 0),"object"==typeof e?map$1(objectKeys(e),function(r){var i=encodeURIComponent(stringifyPrimitive(r))+n;return isArray$1(e[r])?map$1(e[r],function(e){return i+encodeURIComponent(stringifyPrimitive(e))}).join(t):i+encodeURIComponent(stringifyPrimitive(e[r]))}).join(t):r?encodeURIComponent(stringifyPrimitive(r))+n+encodeURIComponent(stringifyPrimitive(e)):""}function map$1(e,t){if(e.map)return e.map(t);for(var n=[],r=0;r<e.length;r++)n.push(t(e[r],r));return n}var objectKeys=Object.keys||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t};function parse(e,t,n,r){t=t||"&",n=n||"=";var i={};if("string"!=typeof e||0===e.length)return i;var s=/\+/g;e=e.split(t);var o=1e3;r&&"number"==typeof r.maxKeys&&(o=r.maxKeys);var a=e.length;o>0&&a>o&&(a=o);for(var u=0;u<a;++u){var c,l,h,p,f=e[u].replace(s,"%20"),d=f.indexOf(n);d>=0?(c=f.substr(0,d),l=f.substr(d+1)):(c=f,l=""),h=decodeURIComponent(c),p=decodeURIComponent(l),hasOwnProperty$1(i,h)?isArray$1(i[h])?i[h].push(p):i[h]=[i[h],p]:i[h]=p}return i}var url={parse:urlParse,resolve:urlResolve,resolveObject:urlResolveObject,format:urlFormat,Url:Url};function Url(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}var protocolPattern=/^([a-z0-9.+-]+:)/i,portPattern=/:[0-9]*$/,simplePathPattern=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,delims=["<",">",'"',"`"," ","\r","\n","\t"],unwise=["{","}","|","\\","^","`"].concat(delims),autoEscape=["'"].concat(unwise),nonHostChars=["%","/","?",";","#"].concat(autoEscape),hostEndingChars=["/","?","#"],hostnameMaxLen=255,hostnamePartPattern=/^[+a-z0-9A-Z_-]{0,63}$/,hostnamePartStart=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,unsafeProtocol={javascript:!0,"javascript:":!0},hostlessProtocol={javascript:!0,"javascript:":!0},slashedProtocol={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0};function urlParse(e,t,n){if(e&&isObject(e)&&e instanceof Url)return e;var r=new Url;return r.parse(e,t,n),r}function parse$1(e,t,n,r){if(!isString(t))throw new TypeError("Parameter 'url' must be a string, not "+typeof t);var i=t.indexOf("?"),s=-1!==i&&i<t.indexOf("#")?"?":"#",o=t.split(s);o[0]=o[0].replace(/\\/g,"/");var a=t=o.join(s);if(a=a.trim(),!r&&1===t.split("#").length){var u=simplePathPattern.exec(a);if(u)return e.path=a,e.href=a,e.pathname=u[1],u[2]?(e.search=u[2],e.query=n?parse(e.search.substr(1)):e.search.substr(1)):n&&(e.search="",e.query={}),e}var c,l,h,p,f=protocolPattern.exec(a);if(f){var d=(f=f[0]).toLowerCase();e.protocol=d,a=a.substr(f.length)}if(r||f||a.match(/^\/\/[^@\/]+@[^@\/]+/)){var m="//"===a.substr(0,2);!m||f&&hostlessProtocol[f]||(a=a.substr(2),e.slashes=!0)}if(!hostlessProtocol[f]&&(m||f&&!slashedProtocol[f])){var v,g,y=-1;for(c=0;c<hostEndingChars.length;c++)-1!==(l=a.indexOf(hostEndingChars[c]))&&(-1===y||l<y)&&(y=l);for(-1!==(g=-1===y?a.lastIndexOf("@"):a.lastIndexOf("@",y))&&(v=a.slice(0,g),a=a.slice(g+1),e.auth=decodeURIComponent(v)),y=-1,c=0;c<nonHostChars.length;c++)-1!==(l=a.indexOf(nonHostChars[c]))&&(-1===y||l<y)&&(y=l);-1===y&&(y=a.length),e.host=a.slice(0,y),a=a.slice(y),parseHost(e),e.hostname=e.hostname||"";var b="["===e.hostname[0]&&"]"===e.hostname[e.hostname.length-1];if(!b){var E=e.hostname.split(/\./);for(c=0,h=E.length;c<h;c++){var _=E[c];if(_&&!_.match(hostnamePartPattern)){for(var O="",S=0,C=_.length;S<C;S++)_.charCodeAt(S)>127?O+="x":O+=_[S];if(!O.match(hostnamePartPattern)){var x=E.slice(0,c),w=E.slice(c+1),N=_.match(hostnamePartStart);N&&(x.push(N[1]),w.unshift(N[2])),w.length&&(a="/"+w.join(".")+a),e.hostname=x.join(".");break}}}}e.hostname.length>hostnameMaxLen?e.hostname="":e.hostname=e.hostname.toLowerCase(),b||(e.hostname=toASCII(e.hostname)),p=e.port?":"+e.port:"";var T=e.hostname||"";e.host=T+p,e.href+=e.host,b&&(e.hostname=e.hostname.substr(1,e.hostname.length-2),"/"!==a[0]&&(a="/"+a))}if(!unsafeProtocol[d])for(c=0,h=autoEscape.length;c<h;c++){var R=autoEscape[c];if(-1!==a.indexOf(R)){var P=encodeURIComponent(R);P===R&&(P=escape(R)),a=a.split(R).join(P)}}var j=a.indexOf("#");-1!==j&&(e.hash=a.substr(j),a=a.slice(0,j));var I=a.indexOf("?");if(-1!==I?(e.search=a.substr(I),e.query=a.substr(I+1),n&&(e.query=parse(e.query)),a=a.slice(0,I)):n&&(e.search="",e.query={}),a&&(e.pathname=a),slashedProtocol[d]&&e.hostname&&!e.pathname&&(e.pathname="/"),e.pathname||e.search){p=e.pathname||"";var L=e.search||"";e.path=p+L}return e.href=format$1(e),e}function urlFormat(e){return isString(e)&&(e=parse$1({},e)),format$1(e)}function format$1(e){var t=e.auth||"";t&&(t=(t=encodeURIComponent(t)).replace(/%3A/i,":"),t+="@");var n=e.protocol||"",r=e.pathname||"",i=e.hash||"",s=!1,o="";e.host?s=t+e.host:e.hostname&&(s=t+(-1===e.hostname.indexOf(":")?e.hostname:"["+this.hostname+"]"),e.port&&(s+=":"+e.port)),e.query&&isObject(e.query)&&Object.keys(e.query).length&&(o=stringify(e.query));var a=e.search||o&&"?"+o||"";return n&&":"!==n.substr(-1)&&(n+=":"),e.slashes||(!n||slashedProtocol[n])&&!1!==s?(s="//"+(s||""),r&&"/"!==r.charAt(0)&&(r="/"+r)):s||(s=""),i&&"#"!==i.charAt(0)&&(i="#"+i),a&&"?"!==a.charAt(0)&&(a="?"+a),n+s+(r=r.replace(/[?#]/g,function(e){return encodeURIComponent(e)}))+(a=a.replace("#","%23"))+i}function urlResolve(e,t){return urlParse(e,!1,!0).resolve(t)}function urlResolveObject(e,t){return e?urlParse(e,!1,!0).resolveObject(t):t}function parseHost(e){var t=e.host,n=portPattern.exec(t);n&&(":"!==(n=n[0])&&(e.port=n.substr(1)),t=t.substr(0,t.length-n.length)),t&&(e.hostname=t)}Url.prototype.parse=function(e,t,n){return parse$1(this,e,t,n)},Url.prototype.format=function(){return format$1(this)},Url.prototype.resolve=function(e){return this.resolveObject(urlParse(e,!1,!0)).format()},Url.prototype.resolveObject=function(e){if(isString(e)){var t=new Url;t.parse(e,!1,!0),e=t}for(var n,r=new Url,i=Object.keys(this),s=0;s<i.length;s++){var o=i[s];r[o]=this[o]}if(r.hash=e.hash,""===e.href)return r.href=r.format(),r;if(e.slashes&&!e.protocol){for(var a=Object.keys(e),u=0;u<a.length;u++){var c=a[u];"protocol"!==c&&(r[c]=e[c])}return slashedProtocol[r.protocol]&&r.hostname&&!r.pathname&&(r.path=r.pathname="/"),r.href=r.format(),r}if(e.protocol&&e.protocol!==r.protocol){if(!slashedProtocol[e.protocol]){for(var l=Object.keys(e),h=0;h<l.length;h++){var p=l[h];r[p]=e[p]}return r.href=r.format(),r}if(r.protocol=e.protocol,e.host||hostlessProtocol[e.protocol])r.pathname=e.pathname;else{for(n=(e.pathname||"").split("/");n.length&&!(e.host=n.shift()););e.host||(e.host=""),e.hostname||(e.hostname=""),""!==n[0]&&n.unshift(""),n.length<2&&n.unshift(""),r.pathname=n.join("/")}if(r.search=e.search,r.query=e.query,r.host=e.host||"",r.auth=e.auth,r.hostname=e.hostname||e.host,r.port=e.port,r.pathname||r.search){var f=r.pathname||"",d=r.search||"";r.path=f+d}return r.slashes=r.slashes||e.slashes,r.href=r.format(),r}var m,v=r.pathname&&"/"===r.pathname.charAt(0),g=e.host||e.pathname&&"/"===e.pathname.charAt(0),y=g||v||r.host&&e.pathname,b=y,E=r.pathname&&r.pathname.split("/")||[],_=r.protocol&&!slashedProtocol[r.protocol];if(n=e.pathname&&e.pathname.split("/")||[],_&&(r.hostname="",r.port=null,r.host&&(""===E[0]?E[0]=r.host:E.unshift(r.host)),r.host="",e.protocol&&(e.hostname=null,e.port=null,e.host&&(""===n[0]?n[0]=e.host:n.unshift(e.host)),e.host=null),y=y&&(""===n[0]||""===E[0])),g)r.host=e.host||""===e.host?e.host:r.host,r.hostname=e.hostname||""===e.hostname?e.hostname:r.hostname,r.search=e.search,r.query=e.query,E=n;else if(n.length)E||(E=[]),E.pop(),E=E.concat(n),r.search=e.search,r.query=e.query;else if(!isNullOrUndefined(e.search))return _&&(r.hostname=r.host=E.shift(),(m=!!(r.host&&r.host.indexOf("@")>0)&&r.host.split("@"))&&(r.auth=m.shift(),r.host=r.hostname=m.shift())),r.search=e.search,r.query=e.query,isNull(r.pathname)&&isNull(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.href=r.format(),r;if(!E.length)return r.pathname=null,r.search?r.path="/"+r.search:r.path=null,r.href=r.format(),r;for(var O=E.slice(-1)[0],S=(r.host||e.host||E.length>1)&&("."===O||".."===O)||""===O,C=0,x=E.length;x>=0;x--)"."===(O=E[x])?E.splice(x,1):".."===O?(E.splice(x,1),C++):C&&(E.splice(x,1),C--);if(!y&&!b)for(;C--;C)E.unshift("..");!y||""===E[0]||E[0]&&"/"===E[0].charAt(0)||E.unshift(""),S&&"/"!==E.join("/").substr(-1)&&E.push("");var w=""===E[0]||E[0]&&"/"===E[0].charAt(0);return _&&(r.hostname=r.host=w?"":E.length?E.shift():"",(m=!!(r.host&&r.host.indexOf("@")>0)&&r.host.split("@"))&&(r.auth=m.shift(),r.host=r.hostname=m.shift())),(y=y||r.host&&E.length)&&!w&&E.unshift(""),E.length?r.pathname=E.join("/"):(r.pathname=null,r.path=null),isNull(r.pathname)&&isNull(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.auth=e.auth||r.auth,r.slashes=r.slashes||e.slashes,r.href=r.format(),r},Url.prototype.parseHost=function(){return parseHost(this)};var url$1=Object.freeze({parse:urlParse,resolve:urlResolve,resolveObject:urlResolveObject,format:urlFormat,default:url,Url:Url}),crypto=window.crypto||window.msCrypto,randomBytes=function(e,t){var n=new Uint8Array(e);return e>0&&crypto.getRandomValues(n),n},crypto_1={randomBytes:randomBytes},VERSION="1.0.0",digits="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",base$1=36,preLen=12,seqLen=10,maxSeq=0xcfd41b9100000,minInc=33,maxInc=333,totalLen=preLen+seqLen,version$2=VERSION;function Nuid(){this.buf=Buffer.alloc(totalLen),this.init()}Nuid.prototype.init=function(){this.setPre(),this.initSeqAndInc(),this.fillSeq()},Nuid.prototype.initSeqAndInc=function(){this.seq=Math.floor(Math.random()*maxSeq),this.inc=Math.floor(Math.random()*(maxInc-minInc)+minInc)},Nuid.prototype.setPre=function(){for(var e=crypto_1.randomBytes(preLen),t=0;t<preLen;t++){var n=e[t]%base$1;this.buf[t]=digits.charCodeAt(n)}},Nuid.prototype.fillSeq=function(){for(var e=this.seq,t=totalLen-1;t>=preLen;t--)this.buf[t]=digits.charCodeAt(e%base$1),e=Math.floor(e/base$1)},Nuid.prototype.next=function(){return this.seq+=this.inc,this.seq>maxSeq&&(this.setPre(),this.initSeqAndInc()),this.fillSeq(),this.buf.toString("ascii")};var g=new Nuid,reset=function(){g.init()},next=function(){return g.next()},_global=g,nuid={version:version$2,reset:reset,next:next,_global:_global},url$2=url$1&&url||url$1,nats0_8_8=createCommonjsModule(function(e,t){var n=/^MSG\s+([^\s\r\n]+)\s+([^\s\r\n]+)\s+(([^\s\r\n]+)[^\S\r\n]+)?(\d+)\r\n/i,r=/^\+OK\s*\r\n/i,i=/^-ERR\s+('.+')?\r\n/i,s=/^PING\r\n/i,o=/^PONG\r\n/i,a=/^INFO\s+([^\r\n]+)\r\n/i,u=/^SUB\s+([^\r\n]+)\r\n/i,c="\r\n",l=c.length;function h(e,t,n){Error.captureStackTrace(this,this.constructor),this.name=this.constructor.name,this.message=e,this.code=t,this.chainedError=n}util$2.inherits(h,Error),t.NatsError=h,t.version="0.8.8",t.BAD_SUBJECT="BAD_SUBJECT",t.BAD_MSG="BAD_MSG",t.BAD_REPLY="BAD_REPLY",t.CONN_CLOSED="CONN_CLOSED",t.BAD_JSON="BAD_JSON",t.BAD_AUTHENTICATION="BAD_AUTHENTICATION",t.INVALID_ENCODING="INVALID_ENCODING",t.SECURE_CONN_REQ="SECURE_CONN_REQ",t.NON_SECURE_CONN_REQ="NON_SECURE_CONN_REQ",t.CLIENT_CERT_REQ="CLIENT_CERT_REQ",t.NATS_PROTOCOL_ERR="NATS_PROTOCOL_ERR",t.REQ_TIMEOUT="REQ_TIMEOUT";var p=t.createInbox=function(){return"_INBOX."+nuid.next()};function f(e){require$$0.EventEmitter.call(this),this.parseOptions(e),this.initState(),this.createConnection()}function d(e){for(var t=e.length-1;t>0;t--){var n=Math.floor(Math.random()*(t+1)),r=e[t];e[t]=e[n],e[n]=r}return e}function m(e){this.url=e,this.didConnect=!1,this.reconnects=0}t.connect=function(e){return new f(e)},util$2.inherits(f,require$$0.EventEmitter),f.prototype.createInbox=p,f.prototype.assignOption=function(e,t,n){void 0===n&&(n=t),void 0!==e[t]&&(this.options[n]=e[t])},f.prototype.parseOptions=function(e){var t=this.options={verbose:!1,pedantic:!1,reconnect:!0,maxReconnectAttempts:10,reconnectTimeWait:2e3,encoding:"utf8",tls:!1,waitOnFirstConnect:!1,pingInterval:12e4,maxPingOut:2,useOldRequestStyle:!1};void 0===e?t.url="nats://localhost:4222":"number"==typeof e?t.url="nats://localhost:"+e:"string"==typeof e?t.url=e:"object"==typeof e&&(void 0!==e.port&&(t.url="nats://localhost:"+e.port),this.assignOption(e,"url"),this.assignOption(e,"uri","url"),this.assignOption(e,"user"),this.assignOption(e,"pass"),this.assignOption(e,"token"),this.assignOption(e,"password","pass"),this.assignOption(e,"verbose"),this.assignOption(e,"pedantic"),this.assignOption(e,"reconnect"),this.assignOption(e,"maxReconnectAttempts"),this.assignOption(e,"reconnectTimeWait"),this.assignOption(e,"servers"),this.assignOption(e,"urls","servers"),this.assignOption(e,"noRandomize"),this.assignOption(e,"NoRandomize","noRandomize"),this.assignOption(e,"dontRandomize","noRandomize"),this.assignOption(e,"encoding"),this.assignOption(e,"tls"),this.assignOption(e,"secure","tls"),this.assignOption(e,"name"),this.assignOption(e,"client","name"),this.assignOption(e,"yieldTime"),this.assignOption(e,"waitOnFirstConnect"),this.assignOption(e,"json"),this.assignOption(e,"preserveBuffers"),this.assignOption(e,"pingInterval"),this.assignOption(e,"maxPingOut"),this.assignOption(e,"useOldRequestStyle"));var n=this;if(n.user=t.user,n.pass=t.pass,n.token=t.token,n.user&&n.token)throw new h("User and Token can not both be provided","BAD_AUTHENTICATION");if(!Buffer.isEncoding(t.encoding))throw new h("Invalid Encoding:"+t.encoding,"INVALID_ENCODING");n.encoding=t.encoding,n.servers=[],Array.isArray(t.servers)?(t.servers.forEach(function(e){n.servers.push(new m(url$2.parse(e)))}),!0!==t.noRandomize&&d(n.servers),void 0!==t.url&&-1===n.servers.indexOf(t.url)&&n.servers.unshift(new m(url$2.parse(t.url)))):(void 0===t.url&&(t.url="nats://localhost:4222"),n.servers.push(new m(url$2.parse(t.url))))},m.prototype.toString=function(){return this.url.href},f.prototype.selectServer=function(){var e=this.servers.shift();if(this.currentServer=e,this.url=e.url,"auth"in e.url&&e.url.auth){var t=e.url.auth.split(":");1!==t.length?(void 0===this.options.user&&(this.user=t[0]),void 0===this.options.pass&&(this.pass=t[1])):void 0===this.options.token&&(this.token=t[0])}this.servers.push(e)},f.prototype.checkTLSMismatch=function(){return!0===this.info.tls_required&&!1===this.options.tls?(this.emit("error",new h("Server requires a secure connection.","SECURE_CONN_REQ")),this.closeStream(),!0):!1===this.info.tls_required&&!1!==this.options.tls?(this.emit("error",new h("Server does not support a secure connection.","NON_SECURE_CONN_REQ")),this.closeStream(),!0):!0===this.info.tls_verify&&void 0===this.options.tls.cert&&(this.emit("error",new h("Server requires a client certificate.","CLIENT_CERT_REQ")),this.closeStream(),!0)},f.prototype.connectCB=function(){var e=!0===this.reconnecting?"reconnect":"connect";this.reconnecting=!1,this.reconnects=0,this.wasConnected=!0,this.currentServer.didConnect=!0,this.emit(e,this),this.flushPending()},f.prototype.scheduleHeartbeat=function(){this.pingTimer=setTimeout(function(e){if(e.emit("pingtimer"),!e.closed){if(e.stream&&!e.stream.connecting){if(e.emit("pingcount",e.pout),e.pout++,e.pout>e.options.maxPingOut)return void e.processErr("stale connection");e.sendCommand("PING\r\n"),e.pongs&&e.pongs.push(void 0)}e.scheduleHeartbeat()}},this.options.pingInterval,this)},f.prototype.setupHandlers=function(){var e=this,t=e.stream;void 0!==t&&(t.on("connect",function(){e.pingTimer&&(clearTimeout(e.pingTimer),delete e.pingTimer),e.connected=!0,e.scheduleHeartbeat()}),t.on("close",function(t){e.closeStream(),e.emit("disconnect"),!0===e.closed||!1===e.options.reconnect||e.reconnects>=e.options.maxReconnectAttempts&&-1!==e.options.maxReconnectAttempts?e.emit("close"):e.scheduleReconnect()}),t.on("error",function(t){!0===e.wasConnected&&!0===e.currentServer.didConnect||(!1===e.wasConnected&&!1===e.currentServer.didConnect&&(e.options.waitOnFirstConnect?e.currentServer.didConnect=!0:e.servers.splice(e.servers.length-1,1)),!1===e.wasConnected&&0===e.servers.length&&e.emit("error",new h("Could not connect to server: "+t,"CONN_ERR",t)),e.closeStream())}),t.on("data",function(t){e.inbound?e.inbound=Buffer.concat([e.inbound,t]):e.inbound=t,e.processInbound()}))},f.prototype.sendConnect=function(){var e={lang:"node",version:"0.8.8",verbose:this.options.verbose,pedantic:this.options.pedantic,protocol:1};void 0!==this.user&&(e.user=this.user,e.pass=this.pass),void 0!==this.token&&(e.auth_token=this.token),void 0!==this.options.name&&(e.name=this.options.name),this.stream.write("CONNECT "+JSON.stringify(e)+c)},f.prototype.createConnection=function(){var e=[],t=[],n=0,r=this;if(null!==r.pending){var i=0;r.pending.forEach(function(s){var o=Buffer.isBuffer(s)?s.length:Buffer.byteLength(s);if("PING\r\n"===s&&null!==r.pongs&&i<r.pongs.length){var a=r.pongs[i++];void 0!==a&&(t.push(s),n+=o,e.push(a))}else s.length>3&&"P"===s[0]&&"U"===s[1]&&"B"===s[2]&&(t.push(s),n+=o)})}this.pongs=e,this.pending=t,this.pSize=n,this.pstate=0,this.info=null,this.infoReceived=!1,this.selectServer(),this.stream&&(this.stream.removeAllListeners(),this.stream.end()),this.stream=net.createConnection(this.url),this.setupHandlers()},f.prototype.initState=function(){this.ssid=1,this.subs={},this.reconnects=0,this.connected=!1,this.wasConnected=!1,this.reconnecting=!1,this.server=null,this.pending=[],this.pout=0},f.prototype.close=function(){this.pingTimer&&(clearTimeout(this.pingTimer),delete this.pingTimer),this.closed=!0,this.removeAllListeners(),this.closeStream(),this.ssid=-1,this.subs=null,this.pstate=-1,this.pongs=null,this.pending=null,this.pSize=0},f.prototype.closeStream=function(){null!==this.stream&&(this.stream.end(),this.stream.destroy(),this.stream=null),!0!==this.connected&&!0!==this.closed||(this.pongs=null,this.pout=0,this.pending=null,this.pSize=0,this.connected=!1),this.inbound=null},f.prototype.flushPending=function(){if(!1!==this.connected&&null!==this.pending&&0!==this.pending.length&&!0===this.infoReceived){var e=this,t=function(t){return e.pending=[],e.pSize=0,e.stream.write(t)};if(this.pBufs){for(var n=!0,r=0;r<this.pending.length;r++)if(!Buffer.isBuffer(this.pending[r])){n=!1;break}if(n)return t(Buffer.concat(this.pending,this.pSize));var i=this.pending;this.pending=[],this.pSize=0;var s=!0;for(r=0;r<i.length;r++)s=this.stream.write(i[r])&&s;return s}return t(this.pending.join(""))}},f.prototype.stripPendingSubs=function(){var e=this.pending;this.pending=[],this.pSize=0;for(var t=0;t<e.length;t++)u.test(e[t])||this.sendCommand(e[t])},f.prototype.sendCommand=function(e){if(!this.closed&&null!==this.pending&&(this.pending.push(e),Buffer.isBuffer(e)?(this.pSize+=e.length,this.pBufs=!0):this.pSize+=Buffer.byteLength(e),!0===this.connected))if(1===this.pending.length){var t=this;setImmediate(function(){t.flushPending()})}else this.pSize>65536&&this.flushPending()},f.prototype.sendSubscriptions=function(){var e="";for(var t in this.subs)if(this.subs.hasOwnProperty(t)){var n=this.subs[t];e+=(n.qgroup?["SUB",n.subject,n.qgroup,t+c]:["SUB",n.subject,t+c]).join(" ")}e.length>0&&this.stream.write(e)},f.prototype.processInbound=function(){var e,t,u=this;if(u.stream)for(u.stream.resume(),void 0!==u.options.yieldTime&&(t=Date.now());!u.closed&&u.inbound&&u.inbound.length>0;){switch(u.pstate){case 0:var c=u.inbound.toString("binary",0,1024);if(null!==(e=n.exec(c)))u.payload={subj:e[1],sid:parseInt(e[2],10),reply:e[4],size:parseInt(e[5],10)},u.payload.psize=u.payload.size+l,u.pstate=1;else if(null!==(e=r.exec(c)));else{if(null!==(e=i.exec(c)))return void u.processErr(e[1]);if(null!==(e=o.exec(c))){u.pout=0;var h=u.pongs&&u.pongs.shift();h&&h()}else if(null!==(e=s.exec(c)))u.sendCommand("PONG\r\n");else{if(null===(e=a.exec(c)))return;if(u.info=JSON.parse(e[1]),!0===u.checkTLSMismatch())return;if(u.processServerUpdate(),!1===u.infoReceived){if(!1!==u.options.tls&&!0!==u.stream.encrypted){var p={socket:u.stream};if("object"==typeof u.options.tls)for(var f in u.options.tls)p[f]=u.options.tls[f];u.stream&&(u.stream.removeAllListeners(),u.stream.end()),u.stream=tls.connect(p,function(){u.flushPending()}),u.setupHandlers()}u.sendConnect(),u.sendSubscriptions(),u.pongs.unshift(function(){u.connectCB()}),u.stream.write("PING\r\n"),u.infoReceived=!0,u.stripPendingSubs(),u.flushPending()}}}break;case 1:if(u.inbound.length<u.payload.psize)return void 0===u.payload.chunks&&(u.payload.chunks=[]),u.payload.chunks.push(u.inbound),u.payload.psize-=u.inbound.length,void(u.inbound=null);if(u.payload.chunks){u.payload.chunks.push(u.inbound.slice(0,u.payload.psize));var d=Buffer.concat(u.payload.chunks,u.payload.size);u.options.preserveBuffers?u.payload.msg=d:u.payload.msg=d.toString(u.encoding)}else u.options.preserveBuffers?u.payload.msg=u.inbound.slice(0,u.payload.size):u.payload.msg=u.inbound.toString(u.encoding,0,u.payload.size);if(u.inbound.length===u.payload.psize?u.inbound=null:u.inbound=u.inbound.slice(u.payload.psize),u.processMsg(),u.pstate=0,u.payload=null,void 0!==t&&Date.now()-t>u.options.yieldTime)return u.stream.pause(),void setImmediate(u.processInbound.bind(this))}if(e&&!this.closed){var m=e[0].length;m>=u.inbound.length?u.inbound=null:u.inbound=u.inbound.slice(m)}e=null}},f.prototype.processServerUpdate=function(){var e=this;if(e.info.connect_urls&&e.info.connect_urls.length>0){var t={};e.info.connect_urls.forEach(function(e){var n="nats://"+e,r=new m(url$2.parse(n));r.implicit=!0,t[r.url.href]=r});var n=[];e.servers.forEach(function(r,i){var s=r.url.href;r.implicit&&e.currentServer.url.href!==s&&void 0===t[s]&&n.push(i),delete t[s]}),n.reverse(),n.forEach(function(t){e.servers.splice(t,1)});var r=[];for(var i in t)t.hasOwnProperty(i)&&(e.servers.push(t[i]),r.push(i));r.length&&e.emit("serversDiscovered",r)}},f.prototype.processMsg=function(){var e=this.subs[this.payload.sid];if(void 0!==e&&(e.received+=1,e.timeout&&e.received>=e.expected&&(clearTimeout(e.timeout),e.timeout=null),void 0!==e.max&&(e.received===e.max?(delete this.subs[this.payload.sid],this.emit("unsubscribe",this.payload.sid,e.subject)):e.received>e.max&&(this.unsubscribe(this.payload.sid),e.callback=null)),e.callback)){var t=this.payload.msg;if(this.options.json)try{t=this.options.preserveBuffers?JSON.parse(this.payload.msg.toString()):JSON.parse(this.payload.msg.toString(this.options.encoding))}catch(e){t=e}e.callback(t,this.payload.reply,this.payload.subj,this.payload.sid)}},f.prototype.processErr=function(e){var t=e?e.toLowerCase():"";-1!==t.indexOf("stale connection")?this.closeStream():-1!==t.indexOf("permissions violation")?this.emit("permission_error",new h(e,"NATS_PROTOCOL_ERR")):(this.emit("error",new h(e,"NATS_PROTOCOL_ERR")),this.closeStream())},f.prototype.addServer=function(e){this.servers.push(new m(url$2.parse(e))),!0!==this.options.noRandomize&&d(this.servers)},f.prototype.flush=function(e){if(this.closed){if("function"==typeof e)return void e(new h("Connection closed","CONN_CLOSED"));throw new h("Connection closed","CONN_CLOSED")}this.pongs&&(this.pongs.push(e),this.sendCommand("PING\r\n"),this.flushPending())},f.prototype.publish=function(e,t,n,r){if("function"==typeof e&&(r=e,e=void 0),t=this.options.json?void 0===t?null:t:t||"",!e){if(!r)throw new h("Subject must be supplied","BAD_SUBJECT");r(new h("Subject must be supplied","BAD_SUBJECT"))}if("function"==typeof t){if(r||n)return void r(new h("Message can't be a function","BAD_MSG"));r=t,t="",n=void 0}if("function"==typeof n){if(r)return void r(new h("Reply can't be a function","BAD_REPLY"));r=n,n=void 0}var i;if(i=void 0===n?"PUB "+e+" ":"PUB "+e+" "+n+" ",Buffer.isBuffer(t)){var s=new Buffer(i.length+t.length+2*l+t.length.toString().length),o=s.write(i+t.length+c);t.copy(s,o),s.write(c,o+t.length),this.sendCommand(s)}else{var a=t;if(this.options.json)try{a=JSON.stringify(t)}catch(e){throw new h("Message should be a JSON object","BAD_JSON")}this.sendCommand(i+Buffer.byteLength(a)+c+a+c)}if(void 0!==r)this.flush(r);else if(this.closed)throw new h("Connection closed","CONN_CLOSED")},f.prototype.subscribe=function(e,t,n){if(this.closed)throw new h("Connection closed","CONN_CLOSED");var r,i,s;return"function"==typeof t?(n=t,t=void 0):t&&"object"==typeof t&&(r=t.queue,i=t.max),this.ssid+=1,this.subs[this.ssid]={subject:e,callback:n,received:0},"string"==typeof r?(this.subs[this.ssid].qgroup=r,s=["SUB",e,r,this.ssid+c]):s=["SUB",e,this.ssid+c],this.sendCommand(s.join(" ")),this.emit("subscribe",this.ssid,e,t),i&&this.unsubscribe(this.ssid,i),this.ssid},f.prototype.unsubscribe=function(e,t){if(e&&!this.closed)if(e<0)this.cancelMuxRequest(e);else{var n;n=t?["UNSUB",e,t+c]:["UNSUB",e+c],this.sendCommand(n.join(" "));var r=this.subs[e];void 0!==r&&(r.max=t,(void 0===r.max||r.received>=r.max)&&(r.timeout&&(clearTimeout(r.timeout),r.timeout=null),delete this.subs[e],this.emit("unsubscribe",e,r.subject)))}},f.prototype.timeout=function(e,t,n,r){if(e){var i=null;if(e<0){var s=this.getMuxRequestConfig(e);s&&s.timeout&&clearTimeout(s.timeout),i=s}else i=this.subs[e];if(i){i.expected=n;var o=this;i.timeout=setTimeout(function(){r(e),o.unsubscribe(e)},t)}}},f.prototype.request=function(e,t,n,r){if(this.options.useOldRequestStyle)return this.oldRequest(e,t,n,r);"function"==typeof t&&(r=t,t="",n=null),"function"==typeof n&&(r=n,n=null),n=n||{};var i=this.initMuxRequestDetails(r,n.max);if(this.publish(e,t,i.inbox),n.timeout){var s=this;i.timeout=setTimeout(function(){i.callback&&i.callback(new h("The request timed out for subscription id: "+i.id,"REQ_TIMEOUT")),s.cancelMuxRequest(i.token)},n.timeout)}return i.id},f.prototype.oldRequest=function(e,t,n,r){"function"==typeof t&&(r=t,t="",n=null),"function"==typeof n&&(r=n,n=null);var i=p(),s=this.subscribe(i,n,function(e,t){r(e,t)});return this.publish(e,t,i),s},f.prototype.requestOne=function(e,t,n,r,i){return this.options.useOldRequestStyle?this.oldRequestOne(e,t,n,r,i):("number"==typeof t&&(i=n,r=t,n=null,t=""),"number"==typeof n&&(i=r,r=n,n=null),(n=n||{}).max=1,n.timeout=r,this.request(e,t,n,i))},f.prototype.extractToken=function(e){return e.substr(this.respmux.inboxPrefixLen)},f.prototype.createResponseMux=function(){if(!this.respmux){var e=this,t=p(),n=t+".*",r=this.subscribe(n,function(t,n,r){var i=e.extractToken(r),s=e.getMuxRequestConfig(i);s&&(s.hasOwnProperty("expected")&&(s.received++,s.received>=s.expected&&e.cancelMuxRequest(i)),s.callback&&s.callback(t,n))});this.respmux={},this.respmux.inbox=t,this.respmux.inboxPrefixLen=t.length+1,this.respmux.subscriptionID=r,this.respmux.requestMap={},this.respmux.nextID=-1}return this.respmux.inbox},f.prototype.initMuxRequestDetails=function(e,t){var n=this.createResponseMux(),r=nuid.next(),i={token:r,callback:e,inbox:n+"."+r,id:this.respmux.nextID--,received:0};return t>0&&(i.expected=t),this.respmux.requestMap[r]=i,i},f.prototype.getMuxRequestConfig=function(e){if("number"==typeof e){var t=null;for(var n in this.respmux.requestMap)if(this.respmux.requestMap.hasOwnProperty(n)){var r=this.respmux.requestMap[n];if(r.id===e){t=r;break}}t&&(e=t.token)}return this.respmux.requestMap[e]},f.prototype.cancelMuxRequest=function(e){var t=this.getMuxRequestConfig(e);return t&&(t.timeout&&clearTimeout(t.timeout),delete this.respmux.requestMap[t.token]),t},f.prototype.oldRequestOne=function(e,t,n,r,i){"number"==typeof t&&(i=n,r=t,n=null,t=""),"number"==typeof n&&(i=r,r=n,n=null),(n=n||{}).max=1;var s=this.request(e,t,n,i);return this.timeout(s,r,1,function(){i(new h("The request timed out for subscription id: "+s,"REQ_TIMEOUT"))}),s},f.prototype.numSubscriptions=function(){return Object.keys(this.subs).length},f.prototype.reconnect=function(){this.closed||(this.reconnects+=1,this.createConnection(),!0===this.currentServer.didConnect&&this.emit("reconnecting"))},f.prototype.scheduleReconnect=function(){var e=this;if(0!==e.servers.length){!0===e.wasConnected&&(e.reconnecting=!0);var t=0;!0===e.servers[0].didConnect&&(t=this.options.reconnectTimeWait),setTimeout(function(){e.reconnect()},t)}}}),nats0_8_8_1=nats0_8_8.NatsError,nats0_8_8_2=nats0_8_8.version,nats0_8_8_3=nats0_8_8.BAD_SUBJECT,nats0_8_8_4=nats0_8_8.BAD_MSG,nats0_8_8_5=nats0_8_8.BAD_REPLY,nats0_8_8_6=nats0_8_8.CONN_CLOSED,nats0_8_8_7=nats0_8_8.BAD_JSON,nats0_8_8_8=nats0_8_8.BAD_AUTHENTICATION,nats0_8_8_9=nats0_8_8.INVALID_ENCODING,nats0_8_8_10=nats0_8_8.SECURE_CONN_REQ,nats0_8_8_11=nats0_8_8.NON_SECURE_CONN_REQ,nats0_8_8_12=nats0_8_8.CLIENT_CERT_REQ,nats0_8_8_13=nats0_8_8.NATS_PROTOCOL_ERR,nats0_8_8_14=nats0_8_8.REQ_TIMEOUT,nats0_8_8_15=nats0_8_8.createInbox,nats0_8_8_16=nats0_8_8.connect;function vueNats(e,t){if(vueNats.installed)return;let n=nats0_8_8.connect(t);Object.defineProperty(e.prototype,"$nats",{get:function(){let e=this;return{subscribe:function(){let t=n.subscribe.apply(n,arguments);return e.$on("hook:beforeDestroy",function(){n.unsubscribe(t)}),t},publish:n.publish.bind(n),request:n.request.bind(n),requestOne:n.requestOne.bind(n),unsubscribe:n.unsubscribe.bind(n),flush:n.flush.bind(n),timeout:n.timeout.bind(n),close:n.close.bind(n)}}})}"undefined"!=typeof window&&window.Vue&&window.Vue.use(vueNats);export default vueNats;
