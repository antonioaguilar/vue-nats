"use strict";function _interopDefault(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var util=_interopDefault(require("util")),events=_interopDefault(require("events")),url=_interopDefault(require("url"));function createCommonjsModule(t,e){return t(e={exports:{}},e.exports),e.exports}var EventEmitter=events.EventEmitter;function WebSocketProxy(t){var e=this;EventEmitter.call(this),this.sock=new WebSocket(t),this.sock.addEventListener("open",function(t){e.emit("connect")}),this.sock.addEventListener("message",function(t){e.emit("data",new Buffer(t.data))}),this.sock.addEventListener("error",function(t){e.emit("error",t)}),this.sock.addEventListener("close",function(t){e.emit("close")})}util.inherits(WebSocketProxy,EventEmitter),WebSocketProxy.prototype.end=function(){this.destroy()},WebSocketProxy.prototype.destroy=function(){this.sock.readyState!==WebSocket.CONNECTING&&this.sock.readyState!==WebSocket.OPEN||this.sock.close()},WebSocketProxy.prototype.write=function(t){this.sock.readyState===WebSocket.OPEN&&this.sock.send(t)},WebSocketProxy.prototype.pause=function(){console.warn("WebSocketProxy stream pause/resume is not supported yet.")},WebSocketProxy.prototype.resume=function(){};var createConnection=function(t){return new WebSocketProxy(t.format({protocol:t.protocol,slashes:t.slashes,host:t.host,hostname:t.hostname,port:t.port,pathname:t.pathname,search:t.search,path:t.path,query:t.query,hash:t.hash}))},net={createConnection:createConnection},connect=function(t,e){throw"TLS is not supported in the browser. Use WSS instead."},tls={connect:connect},crypto=window.crypto||window.msCrypto,randomBytes=function(t,e){var n=new Uint8Array(t);return t>0&&crypto.getRandomValues(n),n},crypto_1={randomBytes:randomBytes},VERSION="0.6.14",digits="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",base=36,preLen=12,seqLen=10,maxSeq=0xcfd41b9100000,minInc=33,maxInc=333,totalLen=preLen+seqLen,version=VERSION;function Nuid(){this.buf=new Buffer(totalLen),this.init()}Nuid.prototype.init=function(){this.setPre(),this.initSeqAndInc(),this.fillSeq()},Nuid.prototype.initSeqAndInc=function(){this.seq=Math.floor(Math.random()*maxSeq),this.inc=Math.floor(Math.random()*(maxInc-minInc)+minInc)},Nuid.prototype.setPre=function(){for(var t=crypto_1.randomBytes(preLen),e=0;e<preLen;e++){var n=t[e]%base;this.buf[e]=digits.charCodeAt(n)}},Nuid.prototype.fillSeq=function(){for(var t=this.seq,e=totalLen-1;e>=preLen;e--)this.buf[e]=digits.charCodeAt(t%base),t=Math.floor(t/base)},Nuid.prototype.next=function(){return this.seq+=this.inc,this.seq>maxSeq&&(this.setPre(),this.initSeqAndInc()),this.fillSeq(),this.buf.toString("ascii")};var g=new Nuid,reset=function(){g.init()},next=function(){return g.next()},_global=g,nuid={version:version,reset:reset,next:next,_global:_global},nats=createCommonjsModule(function(t,e){var n=/^MSG\s+([^\s\r\n]+)\s+([^\s\r\n]+)\s+(([^\s\r\n]+)[^\S\r\n]+)?(\d+)\r\n/i,i=/^\+OK\s*\r\n/i,s=/^-ERR\s+('.+')?\r\n/i,o=/^PING\r\n/i,r=/^PONG\r\n/i,c=/^INFO\s+([^\r\n]+)\r\n/i,a=/^SUB\s+([^\r\n]+)\r\n/i,u="\r\n",h=u.length;e.version="0.6.8";var p=e.createInbox=function(){return"_INBOX."+nuid.next()};function d(t){events.EventEmitter.call(this),this.parseOptions(t),this.initState(),this.createConnection()}function l(t){for(var e=t.length-1;e>0;e--){var n=Math.floor(Math.random()*(e+1)),i=t[e];t[e]=t[n],t[n]=i}return t}function f(t){this.url=t,this.didConnect=!1,this.reconnects=0}e.connect=function(t){return new d(t)},util.inherits(d,events.EventEmitter),d.prototype.createInbox=p,d.prototype.assignOption=function(t,e,n){void 0===n&&(n=e),void 0!==t[e]&&(this.options[n]=t[e])},d.prototype.parseOptions=function(t){var e=this.options={verbose:!1,pedantic:!1,reconnect:!0,maxReconnectAttempts:10,reconnectTimeWait:2e3,encoding:"utf8",tls:!1,waitOnFirstConnect:!1};void 0===t?e.url="nats://localhost:4222":"number"==typeof t?e.url="nats://localhost:"+t:"string"==typeof t?e.url=t:"object"==typeof t&&(void 0!==t.port&&(e.url="nats://localhost:"+t.port),this.assignOption(t,"url"),this.assignOption(t,"uri","url"),this.assignOption(t,"user"),this.assignOption(t,"pass"),this.assignOption(t,"token"),this.assignOption(t,"password","pass"),this.assignOption(t,"verbose"),this.assignOption(t,"pedantic"),this.assignOption(t,"reconnect"),this.assignOption(t,"maxReconnectAttempts"),this.assignOption(t,"reconnectTimeWait"),this.assignOption(t,"servers"),this.assignOption(t,"urls","servers"),this.assignOption(t,"noRandomize"),this.assignOption(t,"NoRandomize","noRandomize"),this.assignOption(t,"dontRandomize","noRandomize"),this.assignOption(t,"encoding"),this.assignOption(t,"tls"),this.assignOption(t,"secure","tls"),this.assignOption(t,"name"),this.assignOption(t,"client","name"),this.assignOption(t,"yieldTime"),this.assignOption(t,"waitOnFirstConnect"),this.assignOption(t,"json"));var n=this;if(n.user=e.user,n.pass=e.pass,n.token=e.token,n.user&&n.token)throw new Error("User and Token can not both be provided");if(!Buffer.isEncoding(e.encoding))throw new Error("Invalid Encoding:"+e.encoding);n.encoding=e.encoding,n.servers=[],Array.isArray(e.servers)?e.servers.forEach(function(t){n.servers.push(new f(url.parse(t)))}):(void 0===e.url&&(e.url="nats://localhost:4222"),n.servers.push(new f(url.parse(e.url)))),!0!==e.noRandomize&&l(n.servers)},d.prototype.selectServer=function(){var t=this.servers.shift();if(this.currentServer=t,this.url=t.url,"auth"in t.url&&t.url.auth){var e=t.url.auth.split(":");1!==e.length?(void 0===this.options.user&&(this.user=e[0]),void 0===this.options.pass&&(this.pass=e[1])):void 0===this.options.token&&(this.token=e[0])}this.servers.push(t)},d.prototype.checkTLSMismatch=function(){return!0===this.info.tls_required&&!1===this.options.tls?(this.emit("error","Server requires a secure connection."),this.closeStream(),!0):!1===this.info.tls_required&&!1!==this.options.tls?(this.emit("error","Server does not support a secure connection."),this.closeStream(),!0):!0===this.info.tls_verify&&void 0===this.options.tls.cert&&(this.emit("error","Server requires a client certificate."),this.closeStream(),!0)},d.prototype.connectCB=function(){var t=!0===this.reconnecting?"reconnect":"connect";this.reconnecting=!1,this.reconnects=0,this.wasConnected=!0,this.currentServer.didConnect=!0,this.emit(t,this),this.flushPending()},d.prototype.setupHandlers=function(){var t=this,e=t.stream;void 0!==e&&(e.on("connect",function(){t.connected=!0}),e.on("close",function(e){t.closeStream(),t.emit("disconnect"),!0===t.closed||!1===t.options.reconnect||t.reconnects>=t.options.maxReconnectAttempts&&-1!==t.options.maxReconnectAttempts?t.emit("close"):t.scheduleReconnect()}),e.on("error",function(e){!0===t.wasConnected&&!0===t.currentServer.didConnect||(!1===t.wasConnected&&!1===t.currentServer.didConnect&&(t.options.waitOnFirstConnect?t.currentServer.didConnect=!0:t.servers.splice(t.servers.length-1,1)),!1===t.wasConnected&&0===t.servers.length&&t.emit("error","Could not connect to server: "+e),t.closeStream())}),e.on("data",function(e){t.inbound?t.inbound=Buffer.concat([t.inbound,e]):t.inbound=e,t.processInbound()}))},d.prototype.sendConnect=function(){var t={lang:"node",version:"0.6.8",verbose:this.options.verbose,pedantic:this.options.pedantic};void 0!==this.user&&(t.user=this.user,t.pass=this.pass),void 0!==this.token&&(t.auth_token=this.token),void 0!==this.options.name&&(t.name=this.options.name),this.stream.write("CONNECT "+JSON.stringify(t)+u)},d.prototype.createConnection=function(){var t=[],e=[],n=0,i=this;if(null!==i.pending){var s=0;i.pending.forEach(function(o){var r=Buffer.isBuffer(o)?o.length:Buffer.byteLength(o);if("PING\r\n"===o&&null!==i.pongs&&s<i.pongs.length){var c=i.pongs[s++];void 0!==c&&(e.push(o),n+=r,t.push(c))}else o.length>3&&"P"==o[0]&&"U"==o[1]&&"B"==o[2]&&(e.push(o),n+=r)})}this.pongs=t,this.pending=e,this.pSize=n,this.pstate=0,this.info=null,this.infoReceived=!1,this.selectServer(),this.stream=net.createConnection(this.url),this.setupHandlers()},d.prototype.initState=function(){this.ssid=1,this.subs={},this.reconnects=0,this.connected=!1,this.wasConnected=!1,this.reconnecting=!1,this.server=null,this.pending=[]},d.prototype.close=function(){this.closed=!0,this.removeAllListeners(),this.closeStream(),this.ssid=-1,this.subs=null,this.pstate=-1,this.pongs=null,this.pending=null,this.pSize=0},d.prototype.closeStream=function(){null!==this.stream&&(this.stream.end(),this.stream.destroy(),this.stream=null),!0!==this.connected&&!0!==this.closed||(this.pongs=null,this.pending=null,this.pSize=0,this.connected=!1),this.inbound=null},d.prototype.flushPending=function(){if(!1!==this.connected&&null!==this.pending&&0!==this.pending.length&&!0===this.infoReceived){var t=this,e=function(e){return t.pending=[],t.pSize=0,t.stream.write(e)};if(this.pBufs){for(var n=!0,i=0;i<this.pending.length;i++)if(!Buffer.isBuffer(this.pending[i])){n=!1;break}if(n)return e(Buffer.concat(this.pending,this.pSize));var s=this.pending;this.pending=[],this.pSize=0;var o=!0;for(i=0;i<s.length;i++)o=this.stream.write(s[i])&&o;return o}return e(this.pending.join(""))}},d.prototype.stripPendingSubs=function(){var t=this.pending;this.pending=[],this.pSize=0;for(var e=0;e<t.length;e++)a.test(t[e])||this.sendCommand(t[e])},d.prototype.sendCommand=function(t){if(!this.closed&&null!==this.pending&&(this.pending.push(t),Buffer.isBuffer(t)?(this.pSize+=t.length,this.pBufs=!0):this.pSize+=Buffer.byteLength(t),!0===this.connected))if(1===this.pending.length){var e=this;setImmediate(function(){e.flushPending()})}else this.pSize>65536&&this.flushPending()},d.prototype.sendSubscriptions=function(){var t="";for(var e in this.subs)if(this.subs.hasOwnProperty(e)){var n=this.subs[e];t+=(n.qgroup?["SUB",n.subject,n.qgroup,e+u]:["SUB",n.subject,e+u]).join(" ")}t.length>0&&this.stream.write(t)},d.prototype.processInbound=function(){var t,e,a=this;for(a.stream.resume(),void 0!==a.options.yieldTime&&(e=Date.now());!a.closed&&a.inbound&&a.inbound.length>0;){switch(a.pstate){case 0:var u=a.inbound.toString("binary",0,512);if(null!==(t=n.exec(u)))a.payload={subj:t[1],sid:parseInt(t[2],10),reply:t[4],size:parseInt(t[5],10)},a.payload.psize=a.payload.size+h,a.pstate=1;else if(null!==(t=i.exec(u)));else if(null!==(t=s.exec(u)))a.emit("error",t[1]);else if(null!==(t=r.exec(u))){var p=a.pongs&&a.pongs.shift();p&&p()}else if(null!==(t=o.exec(u)))a.sendCommand("PONG\r\n");else{if(null===(t=c.exec(u)))return;if(a.info=JSON.parse(t[1]),!0===a.checkTLSMismatch())return;if(!1===a.infoReceived){if(!1!==a.options.tls&&!0!==a.stream.encrypted){var d={socket:a.stream};if("object"==typeof a.options.tls)for(var l in a.options.tls)d[l]=a.options.tls[l];a.stream=tls.connect(d,function(){a.flushPending()}),a.setupHandlers()}a.sendConnect(),a.sendSubscriptions(),a.pongs.unshift(function(){a.connectCB()}),a.stream.write("PING\r\n"),a.infoReceived=!0,a.stripPendingSubs(),a.flushPending()}}break;case 1:if(a.inbound.length<a.payload.psize)return void 0===a.payload.chunks&&(a.payload.chunks=[]),a.payload.chunks.push(a.inbound),a.payload.psize-=a.inbound.length,void(a.inbound=null);if(a.payload.chunks){a.payload.chunks.push(a.inbound.slice(0,a.payload.psize));var f=Buffer.concat(a.payload.chunks,a.payload.size+h);a.payload.msg=f.toString(a.encoding,0,a.payload.size)}else a.payload.msg=a.inbound.toString(a.encoding,0,a.payload.size);if(a.inbound.length===a.payload.psize?a.inbound=null:a.inbound=a.inbound.slice(a.payload.psize),a.processMsg(),a.pstate=0,a.payload=null,void 0!==e&&Date.now()-e>a.options.yieldTime)return a.stream.pause(),void setImmediate(a.processInbound.bind(this))}if(t&&!this.closed){var v=t[0].length;v>=a.inbound.length?a.inbound=null:a.inbound=a.inbound.slice(v)}t=null}},d.prototype.processMsg=function(){var t=this.subs[this.payload.sid];if(void 0!==t&&(t.received+=1,t.timeout&&t.received>=t.expected&&(clearTimeout(t.timeout),t.timeout=null),void 0!==t.max&&(t.received===t.max?(delete this.subs[this.payload.sid],this.emit("unsubscribe",this.payload.sid,t.subject)):t.received>t.max&&(this.unsubscribe(this.payload.sid),t.callback=null)),t.callback)){var e=this.payload.msg;if(this.options.json)try{e=JSON.parse(new Buffer(this.payload.msg,this.options.encoding).toString())}catch(t){e=t}t.callback(e,this.payload.reply,this.payload.subj,this.payload.sid)}},d.prototype.addServer=function(t){this.servers.push(new f(url.parse(t))),!0!==this.options.noRandomize&&l(this.servers)},d.prototype.flush=function(t){if(this.closed){if("function"==typeof t)return void t(new Error("Connection closed"));throw new Error("Connection closed")}this.pongs&&(this.pongs.push(t),this.sendCommand("PING\r\n"),this.flushPending())},d.prototype.publish=function(t,e,n,i){if("function"==typeof t&&(i=t,t=void 0),e||(e=""),!t){if(!i)throw new Error("Subject must be supplied");i(new Error("Subject must be supplied"))}if("function"==typeof e){if(i||n)return void i(new Error("Message can't be a function"));i=e,e="",n=void 0}if("function"==typeof n){if(i)return void i(new Error("Reply can't be a function"));i=n,n=void 0}var s;if(s=void 0===n?"PUB "+t+" ":"PUB "+t+" "+n+" ","ArrayBuffer"in window&&ArrayBuffer.isView(e)&&(e=Buffer.from(e)),Buffer.isBuffer(e)){var o=new Buffer(s.length+e.length+2*h+e.length.toString().length),r=o.write(s+e.length+u);e.copy(o,r),o.write(u,r+e.length),this.sendCommand(o)}else{var c=e;if(this.options.json){if("object"!=typeof e||Array.isArray(e))throw new Error("Message should be a JSON object");try{c=JSON.stringify(e)}catch(t){throw new Error("Message should be a JSON object")}}this.sendCommand(s+Buffer.byteLength(c)+u+c+u)}if(void 0!==i)this.flush(i);else if(this.closed)throw new Error("Connection closed")},d.prototype.subscribe=function(t,e,n){if(this.closed)throw new Error("Connection closed");var i,s,o;return"function"==typeof e?(n=e,e=void 0):e&&"object"==typeof e&&(i=e.queue,s=e.max),this.ssid+=1,this.subs[this.ssid]={subject:t,callback:n,received:0},"string"==typeof i?(this.subs[this.ssid].qgroup=i,o=["SUB",t,i,this.ssid+u]):o=["SUB",t,this.ssid+u],this.sendCommand(o.join(" ")),this.emit("subscribe",this.ssid,t,e),s&&this.unsubscribe(this.ssid,s),this.ssid},d.prototype.unsubscribe=function(t,e){if(t&&!this.closed){var n;n=e?["UNSUB",t,e+u]:["UNSUB",t+u],this.sendCommand(n.join(" "));var i=this.subs[t];void 0!==i&&(i.max=e,(void 0===i.max||i.received>=i.max)&&(delete this.subs[t],this.emit("unsubscribe",t,i.subject)))}},d.prototype.timeout=function(t,e,n,i){if(t){var s=this.subs[t];null!==s&&(s.expected=n,s.timeout=setTimeout(function(){i(t)},e))}},d.prototype.request=function(t,e,n,i){"function"==typeof e&&(i=e,e="",n=null),"function"==typeof n&&(i=n,n=null);var s=p(),o=this.subscribe(s,n,function(t,e){i(t,e)});return this.publish(t,e,s),o},d.prototype.numSubscriptions=function(){return Object.keys(this.subs).length},d.prototype.reconnect=function(){this.closed||(this.reconnects+=1,this.createConnection(),!0===this.currentServer.didConnect&&this.emit("reconnecting"))},d.prototype.scheduleReconnect=function(){var t=this;if(0!==t.servers.length){!0===t.wasConnected&&(t.reconnecting=!0);var e=0;!0===t.servers[0].didConnect&&(e=this.options.reconnectTimeWait),setTimeout(function(){t.reconnect()},e)}}}),nats_1=nats.version,nats_2=nats.createInbox,nats_3=nats.connect;function vueNats(t,e){if(vueNats.installed)return;let n=nats.connect(e);Object.defineProperty(t.prototype,"$nats",{get:function(){let t=this;return{subscribe:function(){let e=n.subscribe.apply(n,arguments);return t.$on("hook:beforeDestroy",function(){n.unsubscribe(e)}),e},unsubscribe:n.unsubscribe.bind(n),publish:n.publish.bind(n),flush:n.flush.bind(n),timeout:n.timeout.bind(n),close:n.close.bind(n)}}})}"undefined"!=typeof window&&window.Vue&&window.Vue.use(vueNats),module.exports=vueNats;
