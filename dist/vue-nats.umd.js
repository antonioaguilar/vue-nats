!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.VUE_NATS=t()}(this,function(){"use strict";function e(){throw new Error("setTimeout has not been defined")}function t(){throw new Error("clearTimeout has not been defined")}var n=e,r=t;function i(t){if(n===setTimeout)return setTimeout(t,0);if((n===e||!n)&&setTimeout)return n=setTimeout,setTimeout(t,0);try{return n(t,0)}catch(e){try{return n.call(null,t,0)}catch(e){return n.call(this,t,0)}}}"function"==typeof global.setTimeout&&(n=setTimeout),"function"==typeof global.clearTimeout&&(r=clearTimeout);var s,o=[],u=!1,a=-1;function c(){u&&s&&(u=!1,s.length?o=s.concat(o):a=-1,o.length&&h())}function h(){if(!u){var e=i(c);u=!0;for(var n=o.length;n;){for(s=o,o=[];++a<n;)s&&s[a].run();a=-1,n=o.length}s=null,u=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===t||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(e)}}function l(e,t){this.fun=e,this.array=t}l.prototype.run=function(){this.fun.apply(null,this.array)};function p(){}var f=p,d=p,m=p,v=p,g=p,y=p,b=p;var O=global.performance||{},w=O.now||O.mozNow||O.msNow||O.oNow||O.webkitNow||function(){return(new Date).getTime()};var S=new Date;var E={nextTick:function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];o.push(new l(e,t)),1!==o.length||u||i(h)},title:"browser",browser:!0,env:{},argv:[],version:"",versions:{},on:f,addListener:d,once:m,off:v,removeListener:g,removeAllListeners:y,emit:b,binding:function(e){throw new Error("process.binding is not supported")},cwd:function(){return"/"},chdir:function(e){throw new Error("process.chdir is not supported")},umask:function(){return 0},hrtime:function(e){var t=.001*w.call(O),n=Math.floor(t),r=Math.floor(t%1*1e9);return e&&(n-=e[0],(r-=e[1])<0&&(n--,r+=1e9)),[n,r]},platform:"browser",release:{},config:{},uptime:function(){return(new Date-S)/1e3}},C="function"==typeof Object.create?function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}:function(e,t){e.super_=t;var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e},x=/%[sdj%]/g;function _(e){if(!J(e)){for(var t=[],n=0;n<arguments.length;n++)t.push(j(arguments[n]));return t.join(" ")}n=1;for(var r=arguments,i=r.length,s=String(e).replace(x,function(e){if("%%"===e)return"%";if(n>=i)return e;switch(e){case"%s":return String(r[n++]);case"%d":return Number(r[n++]);case"%j":try{return JSON.stringify(r[n++])}catch(e){return"[Circular]"}default:return e}}),o=r[n];n<i;o=r[++n])M(o)||!F(o)?s+=" "+o:s+=" "+j(o);return s}function N(e,t){if(Q(global.process))return function(){return N(e,t).apply(this,arguments)};if(!0===E.noDeprecation)return e;var n=!1;return function(){if(!n){if(E.throwDeprecation)throw new Error(t);E.traceDeprecation?console.trace(t):console.error(t),n=!0}return e.apply(this,arguments)}}var R,T={};function A(e){if(Q(R)&&(R=E.env.NODE_DEBUG||""),e=e.toUpperCase(),!T[e])if(new RegExp("\\b"+e+"\\b","i").test(R)){T[e]=function(){var t=_.apply(null,arguments);console.error("%s %d: %s",e,0,t)}}else T[e]=function(){};return T[e]}function j(e,t){var n={seen:[],stylize:I};return arguments.length>=3&&(n.depth=arguments[2]),arguments.length>=4&&(n.colors=arguments[3]),U(t)?n.showHidden=t:t&&ne(n,t),Q(n.showHidden)&&(n.showHidden=!1),Q(n.depth)&&(n.depth=2),Q(n.colors)&&(n.colors=!1),Q(n.customInspect)&&(n.customInspect=!0),n.colors&&(n.stylize=L),k(n,e,n.depth)}function L(e,t){var n=j.styles[t];return n?"["+j.colors[n][0]+"m"+e+"["+j.colors[n][1]+"m":e}function I(e,t){return e}function k(e,t,n){if(e.customInspect&&t&&V(t.inspect)&&t.inspect!==j&&(!t.constructor||t.constructor.prototype!==t)){var r=t.inspect(n,e);return J(r)||(r=k(e,r,n)),r}var i=function(e,t){if(Q(t))return e.stylize("undefined","undefined");if(J(t)){var n="'"+JSON.stringify(t).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(n,"string")}if(P(t))return e.stylize(""+t,"number");if(U(t))return e.stylize(""+t,"boolean");if(M(t))return e.stylize("null","null")}(e,t);if(i)return i;var s=Object.keys(t),o=function(e){var t={};return e.forEach(function(e,n){t[e]=!0}),t}(s);if(e.showHidden&&(s=Object.getOwnPropertyNames(t)),$(t)&&(s.indexOf("message")>=0||s.indexOf("description")>=0))return q(t);if(0===s.length){if(V(t)){var u=t.name?": "+t.name:"";return e.stylize("[Function"+u+"]","special")}if(H(t))return e.stylize(RegExp.prototype.toString.call(t),"regexp");if(W(t))return e.stylize(Date.prototype.toString.call(t),"date");if($(t))return q(t)}var a,c="",h=!1,l=["{","}"];(D(t)&&(h=!0,l=["[","]"]),V(t))&&(c=" [Function"+(t.name?": "+t.name:"")+"]");return H(t)&&(c=" "+RegExp.prototype.toString.call(t)),W(t)&&(c=" "+Date.prototype.toUTCString.call(t)),$(t)&&(c=" "+q(t)),0!==s.length||h&&0!=t.length?n<0?H(t)?e.stylize(RegExp.prototype.toString.call(t),"regexp"):e.stylize("[Object]","special"):(e.seen.push(t),a=h?function(e,t,n,r,i){for(var s=[],o=0,u=t.length;o<u;++o)re(t,String(o))?s.push(B(e,t,n,r,String(o),!0)):s.push("");return i.forEach(function(i){i.match(/^\d+$/)||s.push(B(e,t,n,r,i,!0))}),s}(e,t,n,o,s):s.map(function(r){return B(e,t,n,o,r,h)}),e.seen.pop(),function(e,t,n){if(e.reduce(function(e,t){return 0,t.indexOf("\n")>=0&&0,e+t.replace(/\u001b\[\d\d?m/g,"").length+1},0)>60)return n[0]+(""===t?"":t+"\n ")+" "+e.join(",\n  ")+" "+n[1];return n[0]+t+" "+e.join(", ")+" "+n[1]}(a,c,l)):l[0]+c+l[1]}function q(e){return"["+Error.prototype.toString.call(e)+"]"}function B(e,t,n,r,i,s){var o,u,a;if((a=Object.getOwnPropertyDescriptor(t,i)||{value:t[i]}).get?u=a.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):a.set&&(u=e.stylize("[Setter]","special")),re(r,i)||(o="["+i+"]"),u||(e.seen.indexOf(a.value)<0?(u=M(n)?k(e,a.value,null):k(e,a.value,n-1)).indexOf("\n")>-1&&(u=s?u.split("\n").map(function(e){return"  "+e}).join("\n").substr(2):"\n"+u.split("\n").map(function(e){return"   "+e}).join("\n")):u=e.stylize("[Circular]","special")),Q(o)){if(s&&i.match(/^\d+$/))return u;(o=JSON.stringify(""+i)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(o=o.substr(1,o.length-2),o=e.stylize(o,"name")):(o=o.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),o=e.stylize(o,"string"))}return o+": "+u}function D(e){return Array.isArray(e)}function U(e){return"boolean"==typeof e}function M(e){return null===e}function z(e){return null==e}function P(e){return"number"==typeof e}function J(e){return"string"==typeof e}function G(e){return"symbol"==typeof e}function Q(e){return void 0===e}function H(e){return F(e)&&"[object RegExp]"===Z(e)}function F(e){return"object"==typeof e&&null!==e}function W(e){return F(e)&&"[object Date]"===Z(e)}function $(e){return F(e)&&("[object Error]"===Z(e)||e instanceof Error)}function V(e){return"function"==typeof e}function K(e){return null===e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"symbol"==typeof e||void 0===e}function Y(e){return Buffer.isBuffer(e)}function Z(e){return Object.prototype.toString.call(e)}function X(e){return e<10?"0"+e.toString(10):e.toString(10)}j.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},j.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"};var ee=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function te(){var e,t;console.log("%s - %s",(e=new Date,t=[X(e.getHours()),X(e.getMinutes()),X(e.getSeconds())].join(":"),[e.getDate(),ee[e.getMonth()],t].join(" ")),_.apply(null,arguments))}function ne(e,t){if(!t||!F(t))return e;for(var n=Object.keys(t),r=n.length;r--;)e[n[r]]=t[n[r]];return e}function re(e,t){return Object.prototype.hasOwnProperty.call(e,t)}var ie={inherits:C,_extend:ne,log:te,isBuffer:Y,isPrimitive:K,isFunction:V,isError:$,isDate:W,isObject:F,isRegExp:H,isUndefined:Q,isSymbol:G,isString:J,isNumber:P,isNullOrUndefined:z,isNull:M,isBoolean:U,isArray:D,inspect:j,deprecate:N,format:_,debuglog:A},se=Object.freeze({format:_,deprecate:N,debuglog:A,inspect:j,isArray:D,isBoolean:U,isNull:M,isNullOrUndefined:z,isNumber:P,isString:J,isSymbol:G,isUndefined:Q,isRegExp:H,isObject:F,isDate:W,isError:$,isFunction:V,isPrimitive:K,isBuffer:Y,log:te,inherits:C,_extend:ne,default:ie});function oe(){}function ue(){ue.init.call(this)}function ae(e){return void 0===e._maxListeners?ue.defaultMaxListeners:e._maxListeners}function ce(e,t,n,r){var i,s,o,u;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');if((s=e._events)?(s.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),s=e._events),o=s[t]):(s=e._events=new oe,e._eventsCount=0),o){if("function"==typeof o?o=s[t]=r?[n,o]:[o,n]:r?o.unshift(n):o.push(n),!o.warned&&(i=ae(e))&&i>0&&o.length>i){o.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=e,a.type=t,a.count=o.length,u=a,"function"==typeof console.warn?console.warn(u):console.log(u)}}else o=s[t]=n,++e._eventsCount;return e}function he(e,t,n){var r=!1;function i(){e.removeListener(t,i),r||(r=!0,n.apply(e,arguments))}return i.listener=n,i}function le(e){var t=this._events;if(t){var n=t[e];if("function"==typeof n)return 1;if(n)return n.length}return 0}function pe(e,t){for(var n=new Array(t);t--;)n[t]=e[t];return n}oe.prototype=Object.create(null),ue.EventEmitter=ue,ue.usingDomains=!1,ue.prototype.domain=void 0,ue.prototype._events=void 0,ue.prototype._maxListeners=void 0,ue.defaultMaxListeners=10,ue.init=function(){this.domain=null,ue.usingDomains&&(!(void 0).active||this instanceof(void 0).Domain||(this.domain=(void 0).active)),this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new oe,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},ue.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},ue.prototype.getMaxListeners=function(){return ae(this)},ue.prototype.emit=function(e){var t,n,r,i,s,o,u,a="error"===e;if(o=this._events)a=a&&null==o.error;else if(!a)return!1;if(u=this.domain,a){if(t=arguments[1],!u){if(t instanceof Error)throw t;var c=new Error('Uncaught, unspecified "error" event. ('+t+")");throw c.context=t,c}return t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=u,t.domainThrown=!1,u.emit("error",t),!1}if(!(n=o[e]))return!1;var h="function"==typeof n;switch(r=arguments.length){case 1:!function(e,t,n){if(t)e.call(n);else for(var r=e.length,i=pe(e,r),s=0;s<r;++s)i[s].call(n)}(n,h,this);break;case 2:!function(e,t,n,r){if(t)e.call(n,r);else for(var i=e.length,s=pe(e,i),o=0;o<i;++o)s[o].call(n,r)}(n,h,this,arguments[1]);break;case 3:!function(e,t,n,r,i){if(t)e.call(n,r,i);else for(var s=e.length,o=pe(e,s),u=0;u<s;++u)o[u].call(n,r,i)}(n,h,this,arguments[1],arguments[2]);break;case 4:!function(e,t,n,r,i,s){if(t)e.call(n,r,i,s);else for(var o=e.length,u=pe(e,o),a=0;a<o;++a)u[a].call(n,r,i,s)}(n,h,this,arguments[1],arguments[2],arguments[3]);break;default:for(i=new Array(r-1),s=1;s<r;s++)i[s-1]=arguments[s];!function(e,t,n,r){if(t)e.apply(n,r);else for(var i=e.length,s=pe(e,i),o=0;o<i;++o)s[o].apply(n,r)}(n,h,this,i)}return!0},ue.prototype.addListener=function(e,t){return ce(this,e,t,!1)},ue.prototype.on=ue.prototype.addListener,ue.prototype.prependListener=function(e,t){return ce(this,e,t,!0)},ue.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,he(this,e,t)),this},ue.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,he(this,e,t)),this},ue.prototype.removeListener=function(e,t){var n,r,i,s,o;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(r=this._events))return this;if(!(n=r[e]))return this;if(n===t||n.listener&&n.listener===t)0==--this._eventsCount?this._events=new oe:(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,s=n.length;s-- >0;)if(n[s]===t||n[s].listener&&n[s].listener===t){o=n[s].listener,i=s;break}if(i<0)return this;if(1===n.length){if(n[0]=void 0,0==--this._eventsCount)return this._events=new oe,this;delete r[e]}else!function(e,t){for(var n=t,r=n+1,i=e.length;r<i;n+=1,r+=1)e[n]=e[r];e.pop()}(n,i);r.removeListener&&this.emit("removeListener",e,o||t)}return this},ue.prototype.removeAllListeners=function(e){var t,n;if(!(n=this._events))return this;if(!n.removeListener)return 0===arguments.length?(this._events=new oe,this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=new oe:delete n[e]),this;if(0===arguments.length){for(var r,i=Object.keys(n),s=0;s<i.length;++s)"removeListener"!==(r=i[s])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=new oe,this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)do{this.removeListener(e,t[t.length-1])}while(t[0]);return this},ue.prototype.listeners=function(e){var t,n=this._events;return n&&(t=n[e])?"function"==typeof t?[t.listener||t]:function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(t):[]},ue.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):le.call(e,t)},ue.prototype.listenerCount=le,ue.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var fe=Object.freeze({default:ue,EventEmitter:ue}),de=se&&ie||se,me=fe&&ue||fe;let ve=me.EventEmitter;function ge(e){let t=this;ve.call(this),this.sock=new WebSocket(e),this.sock.addEventListener("open",function(){t.emit("connect")}),this.sock.addEventListener("message",function(e){t.emit("data",new Buffer(e.data))}),this.sock.addEventListener("error",function(e){t.emit("error",e)}),this.sock.addEventListener("close",function(){t.emit("close")})}de.inherits(ge,ve),ge.prototype.end=function(){this.destroy()},ge.prototype.destroy=function(){this.sock.readyState!==WebSocket.CONNECTING&&this.sock.readyState!==WebSocket.OPEN||this.sock.close()},ge.prototype.write=function(e){this.sock.readyState===WebSocket.OPEN&&this.sock.send(e)},ge.prototype.pause=function(){console.warn("WebSocketProxy stream pause/resume is not supported yet.")},ge.prototype.resume=function(){};var ye=function(e){return new ge(e.format({protocol:e.protocol,slashes:e.slashes,host:e.host,hostname:e.hostname,port:e.port,pathname:e.pathname,search:e.search,path:e.path,query:e.query,hash:e.hash}))},be=function(e,t){throw"TLS is not supported in the browser. Use WSS instead."},Oe=2147483647,we=36,Se=1,Ee=26,Ce=38,xe=700,_e=72,Ne=128,Re="-",Te=/[^\x20-\x7E]/,Ae=/[\x2E\u3002\uFF0E\uFF61]/g,je={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},Le=we-Se,Ie=Math.floor,ke=String.fromCharCode;function qe(e){throw new RangeError(je[e])}function Be(e,t){return e+22+75*(e<26)-((0!=t)<<5)}function De(e,t,n){var r=0;for(e=n?Ie(e/xe):e>>1,e+=Ie(e/t);e>Le*Ee>>1;r+=we)e=Ie(e/Le);return Ie(r+(Le+1)*e/(e+Ce))}function Ue(e){return function(e,t){var n=e.split("@"),r="";n.length>1&&(r=n[0]+"@",e=n[1]);var i=function(e,t){for(var n=e.length,r=[];n--;)r[n]=t(e[n]);return r}((e=e.replace(Ae,".")).split("."),t).join(".");return r+i}(e,function(e){return Te.test(e)?"xn--"+function(e){var t,n,r,i,s,o,u,a,c,h,l,p,f,d,m,v=[];for(p=(e=function(e){for(var t,n,r=[],i=0,s=e.length;i<s;)(t=e.charCodeAt(i++))>=55296&&t<=56319&&i<s?56320==(64512&(n=e.charCodeAt(i++)))?r.push(((1023&t)<<10)+(1023&n)+65536):(r.push(t),i--):r.push(t);return r}(e)).length,t=Ne,n=0,s=_e,o=0;o<p;++o)(l=e[o])<128&&v.push(ke(l));for(r=i=v.length,i&&v.push(Re);r<p;){for(u=Oe,o=0;o<p;++o)(l=e[o])>=t&&l<u&&(u=l);for(u-t>Ie((Oe-n)/(f=r+1))&&qe("overflow"),n+=(u-t)*f,t=u,o=0;o<p;++o)if((l=e[o])<t&&++n>Oe&&qe("overflow"),l==t){for(a=n,c=we;!(a<(h=c<=s?Se:c>=s+Ee?Ee:c-s));c+=we)m=a-h,d=we-h,v.push(ke(Be(h+m%d,0))),a=Ie(m/d);v.push(ke(Be(a,0))),s=De(n,f,r==i),n=0,++r}++n,++t}return v.join("")}(e):e})}function Me(e,t){return Object.prototype.hasOwnProperty.call(e,t)}var ze=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)};function Pe(e){switch(typeof e){case"string":return e;case"boolean":return e?"true":"false";case"number":return isFinite(e)?e:"";default:return""}}function Je(e,t){if(e.map)return e.map(t);for(var n=[],r=0;r<e.length;r++)n.push(t(e[r],r));return n}var Ge=Object.keys||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t};function Qe(e,t,n,r){t=t||"&",n=n||"=";var i={};if("string"!=typeof e||0===e.length)return i;var s=/\+/g;e=e.split(t);var o=1e3;r&&"number"==typeof r.maxKeys&&(o=r.maxKeys);var u=e.length;o>0&&u>o&&(u=o);for(var a=0;a<u;++a){var c,h,l,p,f=e[a].replace(s,"%20"),d=f.indexOf(n);d>=0?(c=f.substr(0,d),h=f.substr(d+1)):(c=f,h=""),l=decodeURIComponent(c),p=decodeURIComponent(h),Me(i,l)?ze(i[l])?i[l].push(p):i[l]=[i[l],p]:i[l]=p}return i}var He={parse:ot,resolve:ht,resolveObject:lt,format:at,Url:Fe};function Fe(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}var We=/^([a-z0-9.+-]+:)/i,$e=/:[0-9]*$/,Ve=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,Ke=["{","}","|","\\","^","`"].concat(["<",">",'"',"`"," ","\r","\n","\t"]),Ye=["'"].concat(Ke),Ze=["%","/","?",";","#"].concat(Ye),Xe=["/","?","#"],et=255,tt=/^[+a-z0-9A-Z_-]{0,63}$/,nt=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,rt={javascript:!0,"javascript:":!0},it={javascript:!0,"javascript:":!0},st={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0};function ot(e,t,n){if(e&&F(e)&&e instanceof Fe)return e;var r=new Fe;return r.parse(e,t,n),r}function ut(e,t,n,r){if(!J(t))throw new TypeError("Parameter 'url' must be a string, not "+typeof t);var i=t.indexOf("?"),s=-1!==i&&i<t.indexOf("#")?"?":"#",o=t.split(s);o[0]=o[0].replace(/\\/g,"/");var u=t=o.join(s);if(u=u.trim(),!r&&1===t.split("#").length){var a=Ve.exec(u);if(a)return e.path=u,e.href=u,e.pathname=a[1],a[2]?(e.search=a[2],e.query=n?Qe(e.search.substr(1)):e.search.substr(1)):n&&(e.search="",e.query={}),e}var c,h,l,p,f=We.exec(u);if(f){var d=(f=f[0]).toLowerCase();e.protocol=d,u=u.substr(f.length)}if(r||f||u.match(/^\/\/[^@\/]+@[^@\/]+/)){var m="//"===u.substr(0,2);!m||f&&it[f]||(u=u.substr(2),e.slashes=!0)}if(!it[f]&&(m||f&&!st[f])){var v,g,y=-1;for(c=0;c<Xe.length;c++)-1!==(h=u.indexOf(Xe[c]))&&(-1===y||h<y)&&(y=h);for(-1!==(g=-1===y?u.lastIndexOf("@"):u.lastIndexOf("@",y))&&(v=u.slice(0,g),u=u.slice(g+1),e.auth=decodeURIComponent(v)),y=-1,c=0;c<Ze.length;c++)-1!==(h=u.indexOf(Ze[c]))&&(-1===y||h<y)&&(y=h);-1===y&&(y=u.length),e.host=u.slice(0,y),u=u.slice(y),pt(e),e.hostname=e.hostname||"";var b="["===e.hostname[0]&&"]"===e.hostname[e.hostname.length-1];if(!b){var O=e.hostname.split(/\./);for(c=0,l=O.length;c<l;c++){var w=O[c];if(w&&!w.match(tt)){for(var S="",E=0,C=w.length;E<C;E++)w.charCodeAt(E)>127?S+="x":S+=w[E];if(!S.match(tt)){var x=O.slice(0,c),_=O.slice(c+1),N=w.match(nt);N&&(x.push(N[1]),_.unshift(N[2])),_.length&&(u="/"+_.join(".")+u),e.hostname=x.join(".");break}}}}e.hostname.length>et?e.hostname="":e.hostname=e.hostname.toLowerCase(),b||(e.hostname=Ue(e.hostname)),p=e.port?":"+e.port:"";var R=e.hostname||"";e.host=R+p,e.href+=e.host,b&&(e.hostname=e.hostname.substr(1,e.hostname.length-2),"/"!==u[0]&&(u="/"+u))}if(!rt[d])for(c=0,l=Ye.length;c<l;c++){var T=Ye[c];if(-1!==u.indexOf(T)){var A=encodeURIComponent(T);A===T&&(A=escape(T)),u=u.split(T).join(A)}}var j=u.indexOf("#");-1!==j&&(e.hash=u.substr(j),u=u.slice(0,j));var L=u.indexOf("?");if(-1!==L?(e.search=u.substr(L),e.query=u.substr(L+1),n&&(e.query=Qe(e.query)),u=u.slice(0,L)):n&&(e.search="",e.query={}),u&&(e.pathname=u),st[d]&&e.hostname&&!e.pathname&&(e.pathname="/"),e.pathname||e.search){p=e.pathname||"";var I=e.search||"";e.path=p+I}return e.href=ct(e),e}function at(e){return J(e)&&(e=ut({},e)),ct(e)}function ct(e){var t=e.auth||"";t&&(t=(t=encodeURIComponent(t)).replace(/%3A/i,":"),t+="@");var n,r,i,s,o=e.protocol||"",u=e.pathname||"",a=e.hash||"",c=!1,h="";e.host?c=t+e.host:e.hostname&&(c=t+(-1===e.hostname.indexOf(":")?e.hostname:"["+this.hostname+"]"),e.port&&(c+=":"+e.port)),e.query&&F(e.query)&&Object.keys(e.query).length&&(n=e.query,r=r||"&",i=i||"=",null===n&&(n=void 0),h="object"==typeof n?Je(Ge(n),function(e){var t=encodeURIComponent(Pe(e))+i;return ze(n[e])?Je(n[e],function(e){return t+encodeURIComponent(Pe(e))}).join(r):t+encodeURIComponent(Pe(n[e]))}).join(r):s?encodeURIComponent(Pe(s))+i+encodeURIComponent(Pe(n)):"");var l=e.search||h&&"?"+h||"";return o&&":"!==o.substr(-1)&&(o+=":"),e.slashes||(!o||st[o])&&!1!==c?(c="//"+(c||""),u&&"/"!==u.charAt(0)&&(u="/"+u)):c||(c=""),a&&"#"!==a.charAt(0)&&(a="#"+a),l&&"?"!==l.charAt(0)&&(l="?"+l),o+c+(u=u.replace(/[?#]/g,function(e){return encodeURIComponent(e)}))+(l=l.replace("#","%23"))+a}function ht(e,t){return ot(e,!1,!0).resolve(t)}function lt(e,t){return e?ot(e,!1,!0).resolveObject(t):t}function pt(e){var t=e.host,n=$e.exec(t);n&&(":"!==(n=n[0])&&(e.port=n.substr(1)),t=t.substr(0,t.length-n.length)),t&&(e.hostname=t)}Fe.prototype.parse=function(e,t,n){return ut(this,e,t,n)},Fe.prototype.format=function(){return ct(this)},Fe.prototype.resolve=function(e){return this.resolveObject(ot(e,!1,!0)).format()},Fe.prototype.resolveObject=function(e){if(J(e)){var t=new Fe;t.parse(e,!1,!0),e=t}for(var n,r=new Fe,i=Object.keys(this),s=0;s<i.length;s++){var o=i[s];r[o]=this[o]}if(r.hash=e.hash,""===e.href)return r.href=r.format(),r;if(e.slashes&&!e.protocol){for(var u=Object.keys(e),a=0;a<u.length;a++){var c=u[a];"protocol"!==c&&(r[c]=e[c])}return st[r.protocol]&&r.hostname&&!r.pathname&&(r.path=r.pathname="/"),r.href=r.format(),r}if(e.protocol&&e.protocol!==r.protocol){if(!st[e.protocol]){for(var h=Object.keys(e),l=0;l<h.length;l++){var p=h[l];r[p]=e[p]}return r.href=r.format(),r}if(r.protocol=e.protocol,e.host||it[e.protocol])r.pathname=e.pathname;else{for(n=(e.pathname||"").split("/");n.length&&!(e.host=n.shift()););e.host||(e.host=""),e.hostname||(e.hostname=""),""!==n[0]&&n.unshift(""),n.length<2&&n.unshift(""),r.pathname=n.join("/")}if(r.search=e.search,r.query=e.query,r.host=e.host||"",r.auth=e.auth,r.hostname=e.hostname||e.host,r.port=e.port,r.pathname||r.search){var f=r.pathname||"",d=r.search||"";r.path=f+d}return r.slashes=r.slashes||e.slashes,r.href=r.format(),r}var m,v=r.pathname&&"/"===r.pathname.charAt(0),g=e.host||e.pathname&&"/"===e.pathname.charAt(0),y=g||v||r.host&&e.pathname,b=y,O=r.pathname&&r.pathname.split("/")||[],w=r.protocol&&!st[r.protocol];if(n=e.pathname&&e.pathname.split("/")||[],w&&(r.hostname="",r.port=null,r.host&&(""===O[0]?O[0]=r.host:O.unshift(r.host)),r.host="",e.protocol&&(e.hostname=null,e.port=null,e.host&&(""===n[0]?n[0]=e.host:n.unshift(e.host)),e.host=null),y=y&&(""===n[0]||""===O[0])),g)r.host=e.host||""===e.host?e.host:r.host,r.hostname=e.hostname||""===e.hostname?e.hostname:r.hostname,r.search=e.search,r.query=e.query,O=n;else if(n.length)O||(O=[]),O.pop(),O=O.concat(n),r.search=e.search,r.query=e.query;else if(!z(e.search))return w&&(r.hostname=r.host=O.shift(),(m=!!(r.host&&r.host.indexOf("@")>0)&&r.host.split("@"))&&(r.auth=m.shift(),r.host=r.hostname=m.shift())),r.search=e.search,r.query=e.query,M(r.pathname)&&M(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.href=r.format(),r;if(!O.length)return r.pathname=null,r.search?r.path="/"+r.search:r.path=null,r.href=r.format(),r;for(var S=O.slice(-1)[0],E=(r.host||e.host||O.length>1)&&("."===S||".."===S)||""===S,C=0,x=O.length;x>=0;x--)"."===(S=O[x])?O.splice(x,1):".."===S?(O.splice(x,1),C++):C&&(O.splice(x,1),C--);if(!y&&!b)for(;C--;C)O.unshift("..");!y||""===O[0]||O[0]&&"/"===O[0].charAt(0)||O.unshift(""),E&&"/"!==O.join("/").substr(-1)&&O.push("");var _=""===O[0]||O[0]&&"/"===O[0].charAt(0);return w&&(r.hostname=r.host=_?"":O.length?O.shift():"",(m=!!(r.host&&r.host.indexOf("@")>0)&&r.host.split("@"))&&(r.auth=m.shift(),r.host=r.hostname=m.shift())),(y=y||r.host&&O.length)&&!_&&O.unshift(""),O.length?r.pathname=O.join("/"):(r.pathname=null,r.path=null),M(r.pathname)&&M(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.auth=e.auth||r.auth,r.slashes=r.slashes||e.slashes,r.href=r.format(),r},Fe.prototype.parseHost=function(){return pt(this)};var ft=Object.freeze({parse:ot,resolve:ht,resolveObject:lt,format:at,default:He,Url:Fe}),dt=window.crypto||window.msCrypto,mt=function(e,t){var n=new Uint8Array(e);return e>0&&dt.getRandomValues(n),n},vt="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",gt=22;function yt(){this.buf=new Buffer(gt),this.init()}yt.prototype.init=function(){this.setPre(),this.initSeqAndInc(),this.fillSeq()},yt.prototype.initSeqAndInc=function(){this.seq=Math.floor(0xcfd41b9100000*Math.random()),this.inc=Math.floor(300*Math.random()+33)},yt.prototype.setPre=function(){for(var e=mt(12),t=0;t<12;t++){var n=e[t]%36;this.buf[t]=vt.charCodeAt(n)}},yt.prototype.fillSeq=function(){for(var e=this.seq,t=gt-1;t>=12;t--)this.buf[t]=vt.charCodeAt(e%36),e=Math.floor(e/36)},yt.prototype.next=function(){return this.seq+=this.inc,this.seq>0xcfd41b9100000&&(this.setPre(),this.initSeqAndInc()),this.fillSeq(),this.buf.toString("ascii")};var bt,Ot=new yt,wt=function(){return Ot.next()},St=ft&&He||ft,Et=(function(e,t){var n=/^MSG\s+([^\s\r\n]+)\s+([^\s\r\n]+)\s+(([^\s\r\n]+)[^\S\r\n]+)?(\d+)\r\n/i,r=/^\+OK\s*\r\n/i,i=/^-ERR\s+('.+')?\r\n/i,s=/^PING\r\n/i,o=/^PONG\r\n/i,u=/^INFO\s+([^\r\n]+)\r\n/i,a=/^SUB\s+([^\r\n]+)\r\n/i,c="\r\n",h=c.length;function l(e,t,n){Error.captureStackTrace(this,this.constructor),this.name=this.constructor.name,this.message=e,this.code=t,this.chainedError=n}de.inherits(l,Error),t.NatsError=l,t.version="0.8.8",t.BAD_SUBJECT="BAD_SUBJECT",t.BAD_MSG="BAD_MSG",t.BAD_REPLY="BAD_REPLY",t.CONN_CLOSED="CONN_CLOSED",t.BAD_JSON="BAD_JSON",t.BAD_AUTHENTICATION="BAD_AUTHENTICATION",t.INVALID_ENCODING="INVALID_ENCODING",t.SECURE_CONN_REQ="SECURE_CONN_REQ",t.NON_SECURE_CONN_REQ="NON_SECURE_CONN_REQ",t.CLIENT_CERT_REQ="CLIENT_CERT_REQ",t.NATS_PROTOCOL_ERR="NATS_PROTOCOL_ERR",t.REQ_TIMEOUT="REQ_TIMEOUT";var p=t.createInbox=function(){return"_INBOX."+wt()};function f(e){me.EventEmitter.call(this),this.parseOptions(e),this.initState(),this.createConnection()}function d(e){for(var t=e.length-1;t>0;t--){var n=Math.floor(Math.random()*(t+1)),r=e[t];e[t]=e[n],e[n]=r}return e}function m(e){this.url=e,this.didConnect=!1,this.reconnects=0}t.connect=function(e){return new f(e)},de.inherits(f,me.EventEmitter),f.prototype.createInbox=p,f.prototype.assignOption=function(e,t,n){void 0===n&&(n=t),void 0!==e[t]&&(this.options[n]=e[t])},f.prototype.parseOptions=function(e){var t=this.options={verbose:!1,pedantic:!1,reconnect:!0,maxReconnectAttempts:10,reconnectTimeWait:2e3,encoding:"utf8",tls:!1,waitOnFirstConnect:!1,pingInterval:12e4,maxPingOut:2,useOldRequestStyle:!1};void 0===e?t.url="nats://localhost:4222":"number"==typeof e?t.url="nats://localhost:"+e:"string"==typeof e?t.url=e:"object"==typeof e&&(void 0!==e.port&&(t.url="nats://localhost:"+e.port),this.assignOption(e,"url"),this.assignOption(e,"uri","url"),this.assignOption(e,"user"),this.assignOption(e,"pass"),this.assignOption(e,"token"),this.assignOption(e,"password","pass"),this.assignOption(e,"verbose"),this.assignOption(e,"pedantic"),this.assignOption(e,"reconnect"),this.assignOption(e,"maxReconnectAttempts"),this.assignOption(e,"reconnectTimeWait"),this.assignOption(e,"servers"),this.assignOption(e,"urls","servers"),this.assignOption(e,"noRandomize"),this.assignOption(e,"NoRandomize","noRandomize"),this.assignOption(e,"dontRandomize","noRandomize"),this.assignOption(e,"encoding"),this.assignOption(e,"tls"),this.assignOption(e,"secure","tls"),this.assignOption(e,"name"),this.assignOption(e,"client","name"),this.assignOption(e,"yieldTime"),this.assignOption(e,"waitOnFirstConnect"),this.assignOption(e,"json"),this.assignOption(e,"preserveBuffers"),this.assignOption(e,"pingInterval"),this.assignOption(e,"maxPingOut"),this.assignOption(e,"useOldRequestStyle"));var n=this;if(n.user=t.user,n.pass=t.pass,n.token=t.token,n.user&&n.token)throw new l("User and Token can not both be provided","BAD_AUTHENTICATION");if(!Buffer.isEncoding(t.encoding))throw new l("Invalid Encoding:"+t.encoding,"INVALID_ENCODING");n.encoding=t.encoding,n.servers=[],Array.isArray(t.servers)?(t.servers.forEach(function(e){n.servers.push(new m(St.parse(e)))}),!0!==t.noRandomize&&d(n.servers),void 0!==t.url&&-1===n.servers.indexOf(t.url)&&n.servers.unshift(new m(St.parse(t.url)))):(void 0===t.url&&(t.url="nats://localhost:4222"),n.servers.push(new m(St.parse(t.url))))},m.prototype.toString=function(){return this.url.href},f.prototype.selectServer=function(){var e=this.servers.shift();if(this.currentServer=e,this.url=e.url,"auth"in e.url&&e.url.auth){var t=e.url.auth.split(":");1!==t.length?(void 0===this.options.user&&(this.user=t[0]),void 0===this.options.pass&&(this.pass=t[1])):void 0===this.options.token&&(this.token=t[0])}this.servers.push(e)},f.prototype.checkTLSMismatch=function(){return!0===this.info.tls_required&&!1===this.options.tls?(this.emit("error",new l("Server requires a secure connection.","SECURE_CONN_REQ")),this.closeStream(),!0):!1===this.info.tls_required&&!1!==this.options.tls?(this.emit("error",new l("Server does not support a secure connection.","NON_SECURE_CONN_REQ")),this.closeStream(),!0):!0===this.info.tls_verify&&void 0===this.options.tls.cert&&(this.emit("error",new l("Server requires a client certificate.","CLIENT_CERT_REQ")),this.closeStream(),!0)},f.prototype.connectCB=function(){var e=!0===this.reconnecting?"reconnect":"connect";this.reconnecting=!1,this.reconnects=0,this.wasConnected=!0,this.currentServer.didConnect=!0,this.emit(e,this),this.flushPending()},f.prototype.scheduleHeartbeat=function(){this.pingTimer=setTimeout(function(e){if(e.emit("pingtimer"),!e.closed){if(e.stream&&!e.stream.connecting){if(e.emit("pingcount",e.pout),e.pout++,e.pout>e.options.maxPingOut)return void e.processErr("stale connection");e.sendCommand("PING\r\n"),e.pongs&&e.pongs.push(void 0)}e.scheduleHeartbeat()}},this.options.pingInterval,this)},f.prototype.setupHandlers=function(){var e=this,t=e.stream;void 0!==t&&(t.on("connect",function(){e.pingTimer&&(clearTimeout(e.pingTimer),delete e.pingTimer),e.connected=!0,e.scheduleHeartbeat()}),t.on("close",function(t){e.closeStream(),e.emit("disconnect"),!0===e.closed||!1===e.options.reconnect||e.reconnects>=e.options.maxReconnectAttempts&&-1!==e.options.maxReconnectAttempts?e.emit("close"):e.scheduleReconnect()}),t.on("error",function(t){!0===e.wasConnected&&!0===e.currentServer.didConnect||(!1===e.wasConnected&&!1===e.currentServer.didConnect&&(e.options.waitOnFirstConnect?e.currentServer.didConnect=!0:e.servers.splice(e.servers.length-1,1)),!1===e.wasConnected&&0===e.servers.length&&e.emit("error",new l("Could not connect to server: "+t,"CONN_ERR",t)),e.closeStream())}),t.on("data",function(t){e.inbound?e.inbound=Buffer.concat([e.inbound,t]):e.inbound=t,e.processInbound()}))},f.prototype.sendConnect=function(){var e={lang:"node",version:"0.8.8",verbose:this.options.verbose,pedantic:this.options.pedantic,protocol:1};void 0!==this.user&&(e.user=this.user,e.pass=this.pass),void 0!==this.token&&(e.auth_token=this.token),void 0!==this.options.name&&(e.name=this.options.name),this.stream.write("CONNECT "+JSON.stringify(e)+c)},f.prototype.createConnection=function(){var e=[],t=[],n=0,r=this;if(null!==r.pending){var i=0;r.pending.forEach(function(s){var o=Buffer.isBuffer(s)?s.length:Buffer.byteLength(s);if("PING\r\n"===s&&null!==r.pongs&&i<r.pongs.length){var u=r.pongs[i++];void 0!==u&&(t.push(s),n+=o,e.push(u))}else s.length>3&&"P"===s[0]&&"U"===s[1]&&"B"===s[2]&&(t.push(s),n+=o)})}this.pongs=e,this.pending=t,this.pSize=n,this.pstate=0,this.info=null,this.infoReceived=!1,this.selectServer(),this.stream&&(this.stream.removeAllListeners(),this.stream.end()),this.stream=ye(this.url),this.setupHandlers()},f.prototype.initState=function(){this.ssid=1,this.subs={},this.reconnects=0,this.connected=!1,this.wasConnected=!1,this.reconnecting=!1,this.server=null,this.pending=[],this.pout=0},f.prototype.close=function(){this.pingTimer&&(clearTimeout(this.pingTimer),delete this.pingTimer),this.closed=!0,this.removeAllListeners(),this.closeStream(),this.ssid=-1,this.subs=null,this.pstate=-1,this.pongs=null,this.pending=null,this.pSize=0},f.prototype.closeStream=function(){null!==this.stream&&(this.stream.end(),this.stream.destroy(),this.stream=null),!0!==this.connected&&!0!==this.closed||(this.pongs=null,this.pout=0,this.pending=null,this.pSize=0,this.connected=!1),this.inbound=null},f.prototype.flushPending=function(){if(!1!==this.connected&&null!==this.pending&&0!==this.pending.length&&!0===this.infoReceived){var e=this,t=function(t){return e.pending=[],e.pSize=0,e.stream.write(t)};if(this.pBufs){for(var n=!0,r=0;r<this.pending.length;r++)if(!Buffer.isBuffer(this.pending[r])){n=!1;break}if(n)return t(Buffer.concat(this.pending,this.pSize));var i=this.pending;this.pending=[],this.pSize=0;var s=!0;for(r=0;r<i.length;r++)s=this.stream.write(i[r])&&s;return s}return t(this.pending.join(""))}},f.prototype.stripPendingSubs=function(){var e=this.pending;this.pending=[],this.pSize=0;for(var t=0;t<e.length;t++)a.test(e[t])||this.sendCommand(e[t])},f.prototype.sendCommand=function(e){if(!this.closed&&null!==this.pending&&(this.pending.push(e),Buffer.isBuffer(e)?(this.pSize+=e.length,this.pBufs=!0):this.pSize+=Buffer.byteLength(e),!0===this.connected))if(1===this.pending.length){var t=this;setImmediate(function(){t.flushPending()})}else this.pSize>65536&&this.flushPending()},f.prototype.sendSubscriptions=function(){var e="";for(var t in this.subs)if(this.subs.hasOwnProperty(t)){var n=this.subs[t];e+=(n.qgroup?["SUB",n.subject,n.qgroup,t+c]:["SUB",n.subject,t+c]).join(" ")}e.length>0&&this.stream.write(e)},f.prototype.processInbound=function(){var e,t,a=this;if(a.stream)for(a.stream.resume(),void 0!==a.options.yieldTime&&(t=Date.now());!a.closed&&a.inbound&&a.inbound.length>0;){switch(a.pstate){case 0:var c=a.inbound.toString("binary",0,1024);if(null!==(e=n.exec(c)))a.payload={subj:e[1],sid:parseInt(e[2],10),reply:e[4],size:parseInt(e[5],10)},a.payload.psize=a.payload.size+h,a.pstate=1;else if(null!==(e=r.exec(c)));else{if(null!==(e=i.exec(c)))return void a.processErr(e[1]);if(null!==(e=o.exec(c))){a.pout=0;var l=a.pongs&&a.pongs.shift();l&&l()}else if(null!==(e=s.exec(c)))a.sendCommand("PONG\r\n");else{if(null===(e=u.exec(c)))return;if(a.info=JSON.parse(e[1]),!0===a.checkTLSMismatch())return;if(a.processServerUpdate(),!1===a.infoReceived){if(!1!==a.options.tls&&!0!==a.stream.encrypted){var p={socket:a.stream};if("object"==typeof a.options.tls)for(var f in a.options.tls)p[f]=a.options.tls[f];a.stream&&(a.stream.removeAllListeners(),a.stream.end()),a.stream=be(p,function(){a.flushPending()}),a.setupHandlers()}a.sendConnect(),a.sendSubscriptions(),a.pongs.unshift(function(){a.connectCB()}),a.stream.write("PING\r\n"),a.infoReceived=!0,a.stripPendingSubs(),a.flushPending()}}}break;case 1:if(a.inbound.length<a.payload.psize)return void 0===a.payload.chunks&&(a.payload.chunks=[]),a.payload.chunks.push(a.inbound),a.payload.psize-=a.inbound.length,void(a.inbound=null);if(a.payload.chunks){a.payload.chunks.push(a.inbound.slice(0,a.payload.psize));var d=Buffer.concat(a.payload.chunks,a.payload.size);a.options.preserveBuffers?a.payload.msg=d:a.payload.msg=d.toString(a.encoding)}else a.options.preserveBuffers?a.payload.msg=a.inbound.slice(0,a.payload.size):a.payload.msg=a.inbound.toString(a.encoding,0,a.payload.size);if(a.inbound.length===a.payload.psize?a.inbound=null:a.inbound=a.inbound.slice(a.payload.psize),a.processMsg(),a.pstate=0,a.payload=null,void 0!==t&&Date.now()-t>a.options.yieldTime)return a.stream.pause(),void setImmediate(a.processInbound.bind(this))}if(e&&!this.closed){var m=e[0].length;m>=a.inbound.length?a.inbound=null:a.inbound=a.inbound.slice(m)}e=null}},f.prototype.processServerUpdate=function(){var e=this;if(e.info.connect_urls&&e.info.connect_urls.length>0){var t={};e.info.connect_urls.forEach(function(e){var n="nats://"+e,r=new m(St.parse(n));r.implicit=!0,t[r.url.href]=r});var n=[];e.servers.forEach(function(r,i){var s=r.url.href;r.implicit&&e.currentServer.url.href!==s&&void 0===t[s]&&n.push(i),delete t[s]}),n.reverse(),n.forEach(function(t){e.servers.splice(t,1)});var r=[];for(var i in t)t.hasOwnProperty(i)&&(e.servers.push(t[i]),r.push(i));r.length&&e.emit("serversDiscovered",r)}},f.prototype.processMsg=function(){var e=this.subs[this.payload.sid];if(void 0!==e&&(e.received+=1,e.timeout&&e.received>=e.expected&&(clearTimeout(e.timeout),e.timeout=null),void 0!==e.max&&(e.received===e.max?(delete this.subs[this.payload.sid],this.emit("unsubscribe",this.payload.sid,e.subject)):e.received>e.max&&(this.unsubscribe(this.payload.sid),e.callback=null)),e.callback)){var t=this.payload.msg;if(this.options.json)try{t=this.options.preserveBuffers?JSON.parse(this.payload.msg.toString()):JSON.parse(this.payload.msg.toString(this.options.encoding))}catch(e){t=e}e.callback(t,this.payload.reply,this.payload.subj,this.payload.sid)}},f.prototype.processErr=function(e){var t=e?e.toLowerCase():"";-1!==t.indexOf("stale connection")?this.closeStream():-1!==t.indexOf("permissions violation")?this.emit("permission_error",new l(e,"NATS_PROTOCOL_ERR")):(this.emit("error",new l(e,"NATS_PROTOCOL_ERR")),this.closeStream())},f.prototype.addServer=function(e){this.servers.push(new m(St.parse(e))),!0!==this.options.noRandomize&&d(this.servers)},f.prototype.flush=function(e){if(this.closed){if("function"==typeof e)return void e(new l("Connection closed","CONN_CLOSED"));throw new l("Connection closed","CONN_CLOSED")}this.pongs&&(this.pongs.push(e),this.sendCommand("PING\r\n"),this.flushPending())},f.prototype.publish=function(e,t,n,r){if("function"==typeof e&&(r=e,e=void 0),t||(t=""),!e){if(!r)throw new l("Subject must be supplied","BAD_SUBJECT");r(new l("Subject must be supplied","BAD_SUBJECT"))}if("function"==typeof t){if(r||n)return void r(new l("Message can't be a function","BAD_MSG"));r=t,t="",n=void 0}if("function"==typeof n){if(r)return void r(new l("Reply can't be a function","BAD_REPLY"));r=n,n=void 0}var i;if(i=void 0===n?"PUB "+e+" ":"PUB "+e+" "+n+" ",Buffer.isBuffer(t)){var s=new Buffer(i.length+t.length+2*h+t.length.toString().length),o=s.write(i+t.length+c);t.copy(s,o),s.write(c,o+t.length),this.sendCommand(s)}else{var u=t;if(this.options.json){if("object"!=typeof t)throw new l("Message should be a JSON object","BAD_JSON");try{u=JSON.stringify(t)}catch(e){throw new l("Message should be a JSON object","BAD_JSON")}}this.sendCommand(i+Buffer.byteLength(u)+c+u+c)}if(void 0!==r)this.flush(r);else if(this.closed)throw new l("Connection closed","CONN_CLOSED")},f.prototype.subscribe=function(e,t,n){if(this.closed)throw new l("Connection closed","CONN_CLOSED");var r,i,s;return"function"==typeof t?(n=t,t=void 0):t&&"object"==typeof t&&(r=t.queue,i=t.max),this.ssid+=1,this.subs[this.ssid]={subject:e,callback:n,received:0},"string"==typeof r?(this.subs[this.ssid].qgroup=r,s=["SUB",e,r,this.ssid+c]):s=["SUB",e,this.ssid+c],this.sendCommand(s.join(" ")),this.emit("subscribe",this.ssid,e,t),i&&this.unsubscribe(this.ssid,i),this.ssid},f.prototype.unsubscribe=function(e,t){if(e&&!this.closed)if(e<0)this.cancelMuxRequest(e);else{var n;n=t?["UNSUB",e,t+c]:["UNSUB",e+c],this.sendCommand(n.join(" "));var r=this.subs[e];void 0!==r&&(r.max=t,(void 0===r.max||r.received>=r.max)&&(r.timeout&&(clearTimeout(r.timeout),r.timeout=null),delete this.subs[e],this.emit("unsubscribe",e,r.subject)))}},f.prototype.timeout=function(e,t,n,r){if(e){var i=null;if(e<0){var s=this.getMuxRequestConfig(e);s&&s.timeout&&clearTimeout(s.timeout),i=s}else i=this.subs[e];if(i){i.expected=n;var o=this;i.timeout=setTimeout(function(){r(e),o.unsubscribe(e)},t)}}},f.prototype.request=function(e,t,n,r){if(this.options.useOldRequestStyle)return this.oldRequest(e,t,n,r);"function"==typeof t&&(r=t,t="",n=null),"function"==typeof n&&(r=n,n=null),n=n||{};var i=this.initMuxRequestDetails(r,n.max);if(this.publish(e,t,i.inbox),n.timeout){var s=this;i.timeout=setTimeout(function(){i.callback&&i.callback(new l("The request timed out for subscription id: "+i.id,"REQ_TIMEOUT")),s.cancelMuxRequest(i.token)},n.timeout)}return i.id},f.prototype.oldRequest=function(e,t,n,r){"function"==typeof t&&(r=t,t="",n=null),"function"==typeof n&&(r=n,n=null);var i=p(),s=this.subscribe(i,n,function(e,t){r(e,t)});return this.publish(e,t,i),s},f.prototype.requestOne=function(e,t,n,r,i){return this.options.useOldRequestStyle?this.oldRequestOne(e,t,n,r,i):("number"==typeof t&&(i=n,r=t,n=null,t=""),"number"==typeof n&&(i=r,r=n,n=null),(n=n||{}).max=1,n.timeout=r,this.request(e,t,n,i))},f.prototype.extractToken=function(e){return e.substr(this.respmux.inboxPrefixLen)},f.prototype.createResponseMux=function(){if(!this.respmux){var e=this,t=p(),n=t+".*",r=this.subscribe(n,function(t,n,r){var i=e.extractToken(r),s=e.getMuxRequestConfig(i);s&&(s.hasOwnProperty("expected")&&(s.received++,s.received>=s.expected&&e.cancelMuxRequest(i)),s.callback&&s.callback(t,n))});this.respmux={},this.respmux.inbox=t,this.respmux.inboxPrefixLen=t.length+1,this.respmux.subscriptionID=r,this.respmux.requestMap={},this.respmux.nextID=-1}return this.respmux.inbox},f.prototype.initMuxRequestDetails=function(e,t){var n=this.createResponseMux(),r=wt(),i={token:r,callback:e,inbox:n+"."+r,id:this.respmux.nextID--,received:0};return t>0&&(i.expected=t),this.respmux.requestMap[r]=i,i},f.prototype.getMuxRequestConfig=function(e){if("number"==typeof e){var t=null;for(var n in this.respmux.requestMap)if(this.respmux.requestMap.hasOwnProperty(n)){var r=this.respmux.requestMap[n];if(r.id===e){t=r;break}}t&&(e=t.token)}return this.respmux.requestMap[e]},f.prototype.cancelMuxRequest=function(e){var t=this.getMuxRequestConfig(e);return t&&(t.timeout&&clearTimeout(t.timeout),delete this.respmux.requestMap[t.token]),t},f.prototype.oldRequestOne=function(e,t,n,r,i){"number"==typeof t&&(i=n,r=t,n=null,t=""),"number"==typeof n&&(i=r,r=n,n=null),(n=n||{}).max=1;var s=this.request(e,t,n,i);return this.timeout(s,r,1,function(){i(new l("The request timed out for subscription id: "+s,"REQ_TIMEOUT"))}),s},f.prototype.numSubscriptions=function(){return Object.keys(this.subs).length},f.prototype.reconnect=function(){this.closed||(this.reconnects+=1,this.createConnection(),!0===this.currentServer.didConnect&&this.emit("reconnecting"))},f.prototype.scheduleReconnect=function(){var e=this;if(0!==e.servers.length){!0===e.wasConnected&&(e.reconnecting=!0);var t=0;!0===e.servers[0].didConnect&&(t=this.options.reconnectTimeWait),setTimeout(function(){e.reconnect()},t)}}}(bt={exports:{}},bt.exports),bt.exports);Et.NatsError,Et.version,Et.BAD_SUBJECT,Et.BAD_MSG,Et.BAD_REPLY,Et.CONN_CLOSED,Et.BAD_JSON,Et.BAD_AUTHENTICATION,Et.INVALID_ENCODING,Et.SECURE_CONN_REQ,Et.NON_SECURE_CONN_REQ,Et.CLIENT_CERT_REQ,Et.NATS_PROTOCOL_ERR,Et.REQ_TIMEOUT,Et.createInbox,Et.connect;function Ct(e,t){if(Ct.installed)return;let n=Et.connect(t);Object.defineProperty(e.prototype,"$nats",{get:function(){let e=this;return{subscribe:function(){let t=n.subscribe.apply(n,arguments);return e.$on("hook:beforeDestroy",function(){n.unsubscribe(t)}),t},publish:n.publish.bind(n),request:n.request.bind(n),requestOne:n.requestOne.bind(n),unsubscribe:n.unsubscribe.bind(n),flush:n.flush.bind(n),timeout:n.timeout.bind(n),close:n.close.bind(n)}}})}return"undefined"!=typeof window&&window.Vue&&window.Vue.use(Ct),Ct});
